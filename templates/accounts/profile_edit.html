<!-- messenger_app/templates/accounts/profile_edit.html - COMPLETE FIXED VERSION -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Profile - Connect.io{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Edit Profile</h1>
            <p class="mt-2 text-gray-600">Update your personal information and profile settings.</p>
        </div>

        <!-- Success/Error Messages -->
        {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
            <div class="p-4 rounded-md {% if message.tags == 'success' %}bg-green-50 text-green-800{% else %}bg-red-50 text-red-800{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="px-6 py-8 sm:p-10">
                <form method="POST" enctype="multipart/form-data" class="space-y-8">
                    {% csrf_token %}

                    <!-- Profile Picture Section -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Profile Picture</label>
                            <div class="flex items-center space-x-6">
                                <div class="shrink-0">
                                    <img class="h-24 w-24 object-cover rounded-full border-2 border-gray-300"
                                         src="{{ user.get_profile_picture_url }}"
                                         alt="Current profile picture">
                                </div>
                                <div class="flex-1">
                                    <input type="file"
                                           name="profile_picture"
                                           accept="image/*"
                                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                    <p class="mt-1 text-xs text-gray-500">JPG, PNG or GIF (Max 5MB)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Personal Information -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-medium text-gray-900">Personal Information</h3>

                        <!-- First Name & Last Name -->
                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                            <div>
                                <label for="first_name" class="block text-sm font-medium text-gray-700">First Name</label>
                                <input type="text"
                                       name="first_name"
                                       id="first_name"
                                       value="{{ user.first_name }}"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="last_name" class="block text-sm font-medium text-gray-700">Last Name</label>
                                <input type="text"
                                       name="last_name"
                                       id="last_name"
                                       value="{{ user.last_name }}"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                        </div>

                        <!-- Username -->
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">
                                    @
                                </span>
                                <input type="text"
                                       name="username"
                                       id="username"
                                       value="{{ user.username }}"
                                       disabled
                                       class="block w-full rounded-none rounded-r-md border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">
                            </div>
                            <p class="mt-1 text-xs text-gray-500">Username cannot be changed.</p>
                        </div>

                        <!-- Email -->
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                            <input type="email"
                                   name="email"
                                   id="email"
                                   value="{{ user.email }}"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>

                        <!-- Phone Number -->
                        <div>
                            <label for="phone_number" class="block text-sm font-medium text-gray-700">Phone Number</label>
                            <input type="tel"
                                   name="phone_number"
                                   id="phone_number"
                                   value="{{ user.phone_number|default:'' }}"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <p class="mt-1 text-xs text-gray-500">Format: +9779800000000</p>
                        </div>

                        <!-- Bio -->
                        <div>
                            <label for="bio" class="block text-sm font-medium text-gray-700">Bio</label>
                            <textarea name="bio"
                                      id="bio"
                                      rows="3"
                                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                      placeholder="Tell us about yourself...">{{ user.bio|default:'' }}</textarea>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-medium text-gray-900">Additional Information</h3>

                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                            <!-- Date of Birth -->
                            <div>
                                <label for="date_of_birth" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                                <input type="date"
                                       name="date_of_birth"
                                       id="date_of_birth"
                                       value="{{ user.date_of_birth|date:'Y-m-d'|default:'' }}"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>

                            <!-- Gender -->
                            <div>
                                <label for="gender" class="block text-sm font-medium text-gray-700">Gender</label>
                                <select name="gender"
                                        id="gender"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                    <option value="">Select Gender</option>
                                    <option value="male" {% if user.gender == 'male' %}selected{% endif %}>Male</option>
                                    <option value="female" {% if user.gender == 'female' %}selected{% endif %}>Female</option>
                                    <option value="other" {% if user.gender == 'other' %}selected{% endif %}>Other</option>
                                    <option value="prefer_not" {% if user.gender == 'prefer_not' %}selected{% endif %}>Prefer not to say</option>
                                </select>
                            </div>
                        </div>

                        <!-- Location -->
                        <div>
                            <label for="location" class="block text-sm font-medium text-gray-700">Location</label>
                            <input type="text"
                                   name="location"
                                   id="location"
                                   value="{{ user.location|default:'' }}"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                   placeholder="City, Country">
                        </div>

                        <!-- Website -->
                        <div>
                            <label for="website" class="block text-sm font-medium text-gray-700">Website</label>
                            <input type="url"
                                   name="website"
                                   id="website"
                                   value="{{ user.website|default:'' }}"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                   placeholder="https://example.com">
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                        <a href="{% url 'profile' %}"
                           class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Cancel
                        </a>
                        <button type="submit"
                                class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Account Verification Section (Separate from form) -->
        <div class="mt-8 bg-white shadow rounded-lg overflow-hidden">
            <div class="px-6 py-8 sm:p-10">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Account Verification</h3>
                <p class="text-sm text-gray-600 mb-4">
                    {% if user.is_verified %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        ✓ Verified Account
                    </span>
                    {% else %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                        ⚠️ Not Verified
                    </span>
                    {% endif %}
                </p>
                <p class="text-sm text-gray-600 mb-6">
                    Verify your account to unlock all features. Verification helps us ensure account security and prevent spam.
                </p>
                <a href="{% url 'send_verification_otp' %}"
                   class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    {% if user.is_verified %}Re-verify Account{% else %}Verify Account{% endif %}
                </a>
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="mt-8 bg-white shadow rounded-lg overflow-hidden border border-red-200">
            <div class="px-6 py-8 sm:p-10">
                <h3 class="text-lg font-medium text-red-900 mb-4">Danger Zone</h3>
                <p class="text-sm text-gray-600 mb-6">
                    These actions are irreversible. Please proceed with caution.
                </p>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-red-50 rounded-md">
                        <div>
                            <h4 class="text-sm font-medium text-red-900">Deactivate Account</h4>
                            <p class="mt-1 text-xs text-red-700">Your account will be disabled but not deleted.</p>
                        </div>
                        <a href="{% url 'deactivate_account' %}"
                           onclick="return confirm('Are you sure you want to deactivate your account? You can reactivate by logging in.');"
                           class="px-4 py-2 border border-red-300 rounded-md shadow-sm text-sm font-medium text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            Deactivate
                        </a>
                    </div>

                    <div class="flex items-center justify-between p-4 bg-red-50 rounded-md">
                        <div>
                            <h4 class="text-sm font-medium text-red-900">Delete Account</h4>
                            <p class="mt-1 text-xs text-red-700">Permanently delete your account and all data.</p>
                        </div>
                        <a href="{% url 'delete_account' %}"
                           onclick="return confirm('WARNING: This will permanently delete your account and all data. This action cannot be undone. Are you sure?');"
                           class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            Delete
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for form validation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');

    form.addEventListener('submit', function(event) {
        // Validate file size if file is selected
        const fileInput = document.querySelector('input[type="file"]');
        if (fileInput && fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const maxSize = 5 * 1024 * 1024; // 5MB in bytes

            if (file.size > maxSize) {
                alert('File size exceeds 5MB limit. Please select a smaller file.');
                event.preventDefault();
                return false;
            }

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                alert('Please select a valid image file (JPG, PNG, or GIF).');
                event.preventDefault();
                return false;
            }
        }

        // Validate email
        const emailInput = document.getElementById('email');
        if (emailInput && emailInput.value) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(emailInput.value)) {
                alert('Please enter a valid email address.');
                event.preventDefault();
                return false;
            }
        }

        // Validate phone number format if provided
        const phoneInput = document.getElementById('phone_number');
        if (phoneInput && phoneInput.value) {
            const phoneRegex = /^\+?[1-9]\d{1,14}$/;
            if (!phoneRegex.test(phoneInput.value)) {
                alert('Please enter a valid phone number (e.g., +9779800000000).');
                event.preventDefault();
                return false;
            }
        }

        // Validate date of birth if provided
        const dobInput = document.getElementById('date_of_birth');
        if (dobInput && dobInput.value) {
            const dob = new Date(dobInput.value);
            const today = new Date();
            const minAge = 13; // Minimum age requirement

            let age = today.getFullYear() - dob.getFullYear();
            const monthDiff = today.getMonth() - dob.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                age--;
            }

            if (age < minAge) {
                alert(`You must be at least ${minAge} years old to use this service.`);
                event.preventDefault();
                return false;
            }
        }

        return true;
    });

    // Preview image before upload
    const fileInput = document.querySelector('input[type="file"]');
    const profileImage = document.querySelector('img[alt="Current profile picture"]');

    if (fileInput && profileImage) {
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    profileImage.src = e.target.result;
                }

                reader.readAsDataURL(this.files[0]);
            }
        });
    }

    // Add character counter for bio
    const bioTextarea = document.getElementById('bio');
    if (bioTextarea) {
        const charCounter = document.createElement('p');
        charCounter.className = 'mt-1 text-xs text-gray-500';
        charCounter.textContent = `${bioTextarea.value.length}/500 characters`;

        bioTextarea.parentNode.insertBefore(charCounter, bioTextarea.nextSibling);

        bioTextarea.addEventListener('input', function() {
            charCounter.textContent = `${this.value.length}/500 characters`;

            if (this.value.length > 500) {
                charCounter.classList.add('text-red-500');
            } else {
                charCounter.classList.remove('text-red-500');
            }
        });
    }
});
</script>

<style>
/* Custom styles for better form appearance */
input:focus, textarea:focus, select:focus {
    outline: none;
    ring: 2px;
    ring-color: #3b82f6;
}

/* Style for disabled inputs */
input:disabled, input[readonly] {
    background-color: #f9fafb;
    cursor: not-allowed;
}

/* Style for form sections */
.space-y-6 > div {
    transition: all 0.3s ease;
}

.space-y-6 > div:focus-within {
    transform: translateY(-2px);
}

/* Style for danger zone */
.bg-red-50 {
    background-color: #fef2f2;
}

.border-red-200 {
    border-color: #fecaca;
}

/* Animation for success messages */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.bg-green-50, .bg-red-50 {
    animation: fadeIn 0.5s ease-out;
}

/* Style for verification badge */
.inline-flex.items-center.px-2\\.5.py-0\\.5.rounded-full.text-xs.font-medium {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.8; }
    100% { opacity: 1; }
}

/* Mobile responsive adjustments */
@media (max-width: 640px) {
    .flex.items-center.space-x-6 {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }

    .grid.grid-cols-1.gap-6.sm\\:grid-cols-2 {
        grid-template-columns: 1fr;
    }

    .flex.justify-end.space-x-4 {
        flex-direction: column;
        gap: 0.75rem;
    }

    .flex.justify-end.space-x-4 > * {
        width: 100%;
        text-align: center;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .min-h-screen.bg-gray-50 {
        background-color: #111827;
    }

    .text-gray-900 {
        color: #f9fafb;
    }

    .text-gray-600 {
        color: #d1d5db;
    }

    .bg-white {
        background-color: #1f2937;
    }

    .border-gray-200, .border-gray-300 {
        border-color: #374151;
    }

    input, textarea, select {
        background-color: #374151;
        border-color: #4b5563;
        color: #f9fafb;
    }

    input:disabled, input[readonly] {
        background-color: #4b5563;
        color: #9ca3af;
    }

    .bg-red-50 {
        background-color: #451a1a;
    }

    .text-red-900 {
        color: #fecaca;
    }

    .text-red-700 {
        color: #fca5a5;
    }

    .border-red-200 {
        border-color: #7f1d1d;
    }
}
</style>
{% endblock %}