<!-- templates/accounts/profile_edit.html -->
{% extends 'base.html' %}

{% block title %}Edit Profile - Messenger{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Edit Your Profile</h1>
                        <p class="text-gray-600">Update your personal information</p>
                    </div>
                    <a href="{% url 'profile' %}" class="text-blue-600 hover:text-blue-700 font-medium">
                        ← Back to Profile
                    </a>
                </div>
            </div>

            <div class="p-6">
                <!-- Error Messages -->
                {% if messages %}
                <div class="mb-6">
                    {% for message in messages %}
                    <div class="p-4 rounded-md {% if message.tags == 'error' %}bg-red-50 text-red-700 border border-red-200{% else %}bg-green-50 text-green-700 border border-green-200{% endif %}">
                        {{ message }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <form method="POST" enctype="multipart/form-data" class="space-y-6" id="profile-form">
                    {% csrf_token %}

                    <!-- Profile Picture Section -->
                    <div class="border-b border-gray-200 pb-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Profile Picture</h3>
                        <div class="flex items-center space-x-6">
                            <div class="flex-shrink-0">
                                {% if user.profile_picture %}
                                <img id="current-photo" src="{{ user.profile_picture.url }}" alt="{{ user.username }}"
                                     class="w-24 h-24 rounded-full border-2 border-gray-300 object-cover shadow-sm">
                                {% else %}
                                <div id="current-photo" class="w-24 h-24 rounded-full bg-gradient-to-br from-blue-100 to-purple-100 border-2 border-gray-300 flex items-center justify-center shadow-sm">
                                    <i class="fas fa-user text-gray-500 text-3xl"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex-1">
                                <label for="profile_picture" class="block text-sm font-medium text-gray-700 mb-2">
                                    Upload New Photo
                                </label>
                                <div class="flex items-center space-x-4">
                                    <label for="profile_picture" class="cursor-pointer">
                                        <span class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200 font-medium text-sm">
                                            Choose File
                                        </span>
                                        <input type="file" id="profile_picture" name="profile_picture"
                                               accept="image/jpeg,image/png,image/gif,image/jpg,image/webp"
                                               class="hidden">
                                    </label>
                                    <span id="file-name" class="text-sm text-gray-500">No file chosen</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">
                                    JPG, PNG, GIF, or WebP • Max 10MB • Recommended: 500x500 pixels
                                </p>
                                {% if user.profile_picture %}
                                <div class="mt-2">
                                    <button type="button" id="remove-photo" class="text-red-600 hover:text-red-700 text-sm font-medium">
                                        Remove current photo
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Personal Information -->
                    <div class="border-b border-gray-200 pb-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Personal Information</h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="first_name" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                                <input type="text" id="first_name" name="first_name"
                                       value="{{ user.first_name|default:'' }}"
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                            </div>

                            <div>
                                <label for="last_name" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                                <input type="text" id="last_name" name="last_name"
                                       value="{{ user.last_name|default:'' }}"
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                            </div>
                        </div>

                        <div class="mt-4">
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
                            <input type="email" id="email" name="email"
                                   value="{{ user.email }}" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                        </div>

                        <div class="mt-4">
                            <label for="phone_number" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                            <input type="text" id="phone_number" name="phone_number"
                                   value="{{ user.phone_number|default:'' }}"
                                   placeholder="+1234567890"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="border-b border-gray-200 pb-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Additional Information</h3>

                        <div class="mb-4">
                            <label for="bio" class="block text-sm font-medium text-gray-700 mb-1">Bio</label>
                            <textarea id="bio" name="bio" rows="3" placeholder="Tell us about yourself..."
                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">{{ user.bio|default:'' }}</textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                                <input type="text" id="location" name="location"
                                       value="{{ user.location|default:'' }}"
                                       placeholder="Your city or country"
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                            </div>

                            <div>
                                <label for="website" class="block text-sm font-medium text-gray-700 mb-1">Website</label>
                                <input type="url" id="website" name="website"
                                       value="{{ user.website|default:'' }}"
                                       placeholder="https://example.com"
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label for="date_of_birth" class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                                <input type="date" id="date_of_birth" name="date_of_birth"
                                       value="{% if user.date_of_birth %}{{ user.date_of_birth|date:'Y-m-d' }}{% endif %}"
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                            </div>

                            <div>
                                <label for="gender" class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                                <select id="gender" name="gender"
                                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                                    <option value="">Select Gender</option>
                                    <option value="male" {% if user.gender == 'male' %}selected{% endif %}>Male</option>
                                    <option value="female" {% if user.gender == 'female' %}selected{% endif %}>Female</option>
                                    <option value="other" {% if user.gender == 'other' %}selected{% endif %}>Other</option>
                                    <option value="prefer_not" {% if user.gender == 'prefer_not' %}selected{% endif %}>Prefer not to say</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-end space-x-3 pt-4">
                        <a href="{% url 'profile' %}"
                            class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-200 font-medium">
                            Cancel
                        </a>
                        <button type="submit" id="save-button"
                                class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200 font-medium flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="button-text">Save Changes</span>
                            <div id="loading-spinner" class="hidden ml-2">
                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                            </div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('profile-form');
    const saveButton = document.getElementById('save-button');
    const buttonText = document.getElementById('button-text');
    const loadingSpinner = document.getElementById('loading-spinner');
    const fileInput = document.getElementById('profile_picture');
    const fileName = document.getElementById('file-name');
    const removePhotoBtn = document.getElementById('remove-photo');

    // File input change handler
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            fileName.textContent = file.name;

            // Validate file type
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/jpg', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                alert('Please select a valid image file (JPEG, PNG, GIF, WebP).');
                fileInput.value = '';
                fileName.textContent = 'No file chosen';
                return;
            }

            // Validate file size (10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('File is too large. Maximum size is 10MB.');
                fileInput.value = '';
                fileName.textContent = 'No file chosen';
                return;
            }

            // Preview image
            const reader = new FileReader();
            reader.onload = function(e) {
                const currentPhoto = document.getElementById('current-photo');
                if (currentPhoto.tagName === 'IMG') {
                    currentPhoto.src = e.target.result;
                } else {
                    const container = currentPhoto.parentElement;
                    const newImg = document.createElement('img');
                    newImg.src = e.target.result;
                    newImg.alt = 'Preview';
                    newImg.className = 'w-24 h-24 rounded-full border-2 border-gray-300 object-cover shadow-sm';
                    newImg.id = 'current-photo';
                    container.innerHTML = '';
                    container.appendChild(newImg);

                    // Show remove button
                    if (!removePhotoBtn) {
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.id = 'remove-photo';
                        removeBtn.className = 'text-red-600 hover:text-red-700 text-sm font-medium mt-2';
                        removeBtn.textContent = 'Remove photo';
                        removeBtn.addEventListener('click', removePhoto);
                        container.parentElement.querySelector('.flex-1').appendChild(removeBtn);
                    }
                }
            };
            reader.readAsDataURL(file);
        } else {
            fileName.textContent = 'No file chosen';
        }
    });

    // Remove photo functionality
    function removePhoto() {
        fileInput.value = '';
        fileName.textContent = 'No file chosen';

        const currentPhoto = document.getElementById('current-photo');
        const container = currentPhoto.parentElement;

        // Replace with default avatar
        const defaultAvatar = document.createElement('div');
        defaultAvatar.className = 'w-24 h-24 rounded-full bg-gradient-to-br from-blue-100 to-purple-100 border-2 border-gray-300 flex items-center justify-center shadow-sm';
        defaultAvatar.id = 'current-photo';
        defaultAvatar.innerHTML = '<i class="fas fa-user text-gray-500 text-3xl"></i>';

        container.innerHTML = '';
        container.appendChild(defaultAvatar);

        // Remove remove button
        if (removePhotoBtn) {
            removePhotoBtn.remove();
        }
    }

    if (removePhotoBtn) {
        removePhotoBtn.addEventListener('click', removePhoto);
    }

    // Form submission feedback
    form.addEventListener('submit', function() {
        buttonText.textContent = 'Saving...';
        loadingSpinner.classList.remove('hidden');
        saveButton.disabled = true;
    });
});
</script>
{% endblock %}