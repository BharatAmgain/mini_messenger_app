<!-- templates/chat/conversation.html -->
{% extends 'base.html' %}
{% load static %}
{% load chat_filters %}

{% block title %}{% if is_group %}{{ conversation.group_name }} - Group Chat{% else %}Chat with {{ other_user.username }}{% endif %} - Messenger{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto">
        <div class="flex h-screen">
            <!-- Sidebar (keep your existing sidebar code) -->
            <div class="w-80 bg-white border-r border-gray-200">
                <!-- Your existing sidebar code remains the same -->
            </div>

            <!-- Main Chat Area -->
            <div class="flex-1 flex flex-col">
                <!-- In the chat header section of conversation.html -->
                <div class="bg-white border-b border-gray-200 p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            {% if is_group %}
                                {% if conversation.group_photo %}
                                <img src="{{ conversation.group_photo.url }}" alt="{{ conversation.group_name }}" class="w-12 h-12 rounded-full object-cover">
                                {% else %}
                                <div class="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center">
                                    <i class="fas fa-users text-white text-xl"></i>
                                </div>
                                {% endif %}
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-900">{{ conversation.group_name }}</h2>
                                    <p class="text-sm text-gray-600">{{ group_members.count }} members</p>
                                </div>
                            {% else %}
                                <!-- Keep existing direct chat header -->
                            {% endif %}
                        </div>

                        <div class="flex items-center space-x-2">
                            {% if is_group %}
                            <a href="{% url 'group_settings' conversation.id %}" class="text-gray-600 hover:text-gray-900 p-2 rounded-lg hover:bg-gray-100" title="Group Settings">
                                <i class="fas fa-cog"></i>
                            </a>

                            <!-- Leave Group Button -->
                            <form method="POST" action="{% url 'leave_group' conversation.id %}"
                                  onsubmit="return confirm('Are you sure you want to leave this group? You will need to be invited back to rejoin.');">
                                {% csrf_token %}
                                <button type="submit" class="text-orange-600 hover:text-orange-800 p-2 rounded-lg hover:bg-orange-50" title="Leave Group">
                                    <i class="fas fa-sign-out-alt"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Messages Area -->
                <div class="flex-1 overflow-y-auto p-4 bg-gray-50" id="messages-container">
                    <div class="space-y-4" id="messages-list">
                        {% for message in messages %}
                        <div class="message-group flex {% if message.sender == request.user %}justify-end{% else %}justify-start{% endif %}"
                             data-message-id="{{ message.id }}">

                            <div class="message-bubble relative group max-w-xs lg:max-w-md px-4 py-2 rounded-lg {% if message.sender == request.user %}bg-blue-600 text-white{% else %}bg-white border border-gray-200 text-gray-900{% endif %}">

                                <!-- Message Header for Group -->
                                {% if is_group and message.sender != request.user and not message.is_unsent %}
                                <p class="text-xs font-medium {% if message.sender == request.user %}text-blue-100{% else %}text-blue-600{% endif %} mb-1">
                                    {{ message.sender.username }}
                                </p>
                                {% endif %}

                                <!-- Message Content -->
                                {% if message.is_unsent %}
                                <p class="text-sm italic opacity-70">This message was unsent</p>
                                {% else %}
                                    {% if message.message_type == 'text' %}
                                    <p class="text-sm message-content">{{ message.content }}</p>
                                    {% elif message.message_type == 'emoji' %}
                                    <div class="emoji-message text-4xl text-center py-2">
                                        {{ message.content }}
                                    </div>
                                    {% elif message.message_type == 'image' %}
                                    <div class="mb-2">
                                        <img src="{{ message.file.url }}" alt="Shared image"
                                             class="max-w-full h-auto rounded-lg cursor-pointer"
                                             onclick="openMediaModal('{{ message.file.url }}', 'image')">
                                    </div>
                                    {% if message.content %}
                                    <p class="text-sm message-content mt-2">{{ message.content }}</p>
                                    {% endif %}
                                    {% elif message.message_type == 'video' %}
                                    <div class="mb-2">
                                        <video controls class="max-w-full h-auto rounded-lg cursor-pointer"
                                               onclick="openMediaModal('{{ message.file.url }}', 'video')">
                                            <source src="{{ message.file.url }}" type="video/mp4">
                                            Your browser does not support the video tag.
                                        </video>
                                    </div>
                                    {% if message.content %}
                                    <p class="text-sm message-content mt-2">{{ message.content }}</p>
                                    {% endif %}
                                    {% elif message.message_type == 'audio' %}
                                    <div class="mb-2">
                                        <audio controls class="w-full">
                                            <source src="{{ message.file.url }}" type="audio/mpeg">
                                            Your browser does not support the audio element.
                                        </audio>
                                    </div>
                                    {% if message.content %}
                                    <p class="text-sm message-content mt-2">{{ message.content }}</p>
                                    {% endif %}
                                    {% elif message.message_type == 'file' %}
                                    <div class="mb-2 p-3 bg-{% if message.sender == request.user %}white bg-opacity-20{% else %}gray-100{% endif %} rounded-lg">
                                        <div class="flex items-center space-x-3">
                                            <div class="flex-shrink-0 w-10 h-10 bg-{% if message.sender == request.user %}white bg-opacity-30{% else %}blue-100{% endif %} rounded-lg flex items-center justify-center">
                                                <i class="fas fa-file {% if message.sender == request.user %}text-white{% else %}text-blue-600{% endif %}"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm font-medium {% if message.sender == request.user %}text-white{% else %}text-gray-900{% endif %} truncate">
                                                    {{ message.file_name|default:"File" }}
                                                </p>
                                                <p class="text-xs {% if message.sender == request.user %}text-blue-100{% else %}text-gray-500{% endif %}">
                                                    {{ message.get_file_size_display }}
                                                </p>
                                            </div>
                                            <a href="{{ message.file.url }}" download
                                               class="flex-shrink-0 p-2 {% if message.sender == request.user %}bg-white bg-opacity-20 hover:bg-opacity-30{% else %}bg-blue-100 hover:bg-blue-200{% endif %} rounded-lg transition duration-200"
                                               title="Download file">
                                                <i class="fas fa-download {% if message.sender == request.user %}text-white{% else %}text-blue-600{% endif %} text-sm"></i>
                                            </a>
                                        </div>
                                    </div>
                                    {% if message.content %}
                                    <p class="text-sm message-content mt-2">{{ message.content }}</p>
                                    {% endif %}
                                    {% endif %}
                                {% endif %}

                                <!-- Message Meta -->
                                <div class="flex items-center justify-between mt-1">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs opacity-70 {% if message.sender == request.user %}text-blue-100{% else %}text-gray-500{% endif %}">
                                            {{ message.timestamp|time }}
                                        </span>

                                        {% if message.is_edited and not message.is_unsent %}
                                        <span class="text-xs opacity-70 {% if message.sender == request.user %}text-blue-100{% else %}text-gray-500{% endif %}">
                                            edited
                                        </span>
                                        {% endif %}

                                        {% if message.sender == request.user and not message.is_unsent %}
                                            {% if message.is_read %}
                                            <i class="fas fa-check-double text-xs opacity-70 {% if message.sender == request.user %}text-blue-100{% else %}text-gray-500{% endif %}"></i>
                                            {% else %}
                                            <i class="fas fa-check text-xs opacity-70 {% if message.sender == request.user %}text-blue-100{% else %}text-gray-500{% endif %}"></i>
                                            {% endif %}
                                        {% endif %}
                                    </div>

                                    <!-- Reactions -->
                                    {% if not message.is_unsent %}
                                    <div class="message-reactions flex space-x-1">
                                        {% for emoji, count in message.get_reaction_summary.items %}
                                        <span class="text-xs {% if message.sender == request.user %}bg-white bg-opacity-20{% else %}bg-gray-100{% endif %} rounded-full px-1">
                                            {{ emoji }} {{ count }}
                                        </span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Message Actions (hover menu) -->
                                {% if message.sender == request.user and not message.is_unsent %}
                                <div class="message-actions absolute -top-8 right-0 bg-white border border-gray-300 rounded-lg shadow-lg p-1 hidden group-hover:flex space-x-1">
                                    <!-- Edit Button (only for text messages) -->
                                    {% if message.message_type == 'text' %}
                                    <button onclick="editMessage('{{ message.id }}')"
                                            class="p-1 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded transition duration-200"
                                            title="Edit message">
                                        <i class="fas fa-edit text-xs"></i>
                                    </button>
                                    {% endif %}

                                    <!-- Unsend Button -->
                                    <button onclick="unsendMessage('{{ message.id }}')"
                                            class="p-1 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition duration-200"
                                            title="Unsend message">
                                        <i class="fas fa-trash text-xs"></i>
                                    </button>

                                    <!-- React Button -->
                                    <div class="relative">
                                        <button onclick="toggleReactions('{{ message.id }}')"
                                                class="p-1 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded transition duration-200"
                                                title="Add reaction">
                                            <i class="fas fa-smile text-xs"></i>
                                        </button>

                                        <!-- Reaction Picker -->
                                        <div id="reactions-{{ message.id }}" class="reaction-picker absolute bottom-full left-0 bg-white border border-gray-300 rounded-lg shadow-lg p-2 hidden grid grid-cols-3 gap-1 z-50">
                                            {% for emoji in 'ğŸ‘,â¤ï¸,ğŸ˜‚,ğŸ˜®,ğŸ˜¢,ğŸ˜¡'|split:',' %}
                                            <button onclick="addReaction('{{ message.id }}', '{{ emoji }}')"
                                                    class="p-1 hover:bg-gray-100 rounded text-lg transition duration-200">
                                                {{ emoji }}
                                            </button>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% elif not message.is_unsent %}
                                <!-- React button for others' messages -->
                                <div class="message-actions absolute -top-8 right-0 bg-white border border-gray-300 rounded-lg shadow-lg p-1 hidden group-hover:flex">
                                    <div class="relative">
                                        <button onclick="toggleReactions('{{ message.id }}')"
                                                class="p-1 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded transition duration-200"
                                                title="Add reaction">
                                            <i class="fas fa-smile text-xs"></i>
                                        </button>

                                        <div id="reactions-{{ message.id }}" class="reaction-picker absolute bottom-full left-0 bg-white border border-gray-300 rounded-lg shadow-lg p-2 hidden grid grid-cols-3 gap-1 z-50">
                                            {% for emoji in 'ğŸ‘,â¤ï¸,ğŸ˜‚,ğŸ˜®,ğŸ˜¢,ğŸ˜¡'|split:',' %}
                                            <button onclick="addReaction('{{ message.id }}', '{{ emoji }}')"
                                                    class="p-1 hover:bg-gray-100 rounded text-lg transition duration-200">
                                                {{ emoji }}
                                            </button>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-8" id="empty-state">
                            <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                <i class="fas fa-comments text-gray-400 text-xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No messages yet</h3>
                            <p class="text-gray-600">
                                {% if is_group %}
                                    Start the conversation in your group!
                                {% else %}
                                    Send a message to start the conversation.
                                {% endif %}
                            </p>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Typing Indicator -->
                    <div id="typing-indicator" class="hidden flex justify-start mt-4">
                        <div class="max-w-xs px-4 py-2 rounded-lg bg-white border border-gray-200">
                            <div class="flex space-x-1">
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1" id="typing-text">
                                {% if is_group %}
                                    Someone is typing...
                                {% else %}
                                    {{ other_user.username }} is typing...
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="bg-white border-t border-gray-200 p-4">
                    <form method="POST" class="flex space-x-4" id="message-form" action="{% url 'conversation' conversation.id %}" enctype="multipart/form-data">
                        {% csrf_token %}

                        <!-- File Upload Button -->
                        <div class="relative">
                            <input
                                type="file"
                                id="file-input"
                                name="file"
                                accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip"
                                class="hidden"
                            >
                            <button type="button" onclick="document.getElementById('file-input').click()"
                                    class="p-2 text-gray-600 hover:text-blue-600 hover:bg-gray-100 rounded-full transition duration-200"
                                    title="Attach file">
                                <i class="fas fa-paperclip"></i>
                            </button>
                        </div>

                        <!-- Emoji Picker Button -->
                        <div class="relative">
                            <button type="button" onclick="toggleEmojiPicker()"
                                    class="p-2 text-gray-600 hover:text-yellow-500 hover:bg-gray-100 rounded-full transition duration-200"
                                    title="Add emoji">
                                <i class="fas fa-smile"></i>
                            </button>

                            <!-- Emoji Picker -->
                            <div id="emoji-picker" class="absolute bottom-12 left-0 w-80 h-96 bg-white border border-gray-300 rounded-lg shadow-xl hidden z-50">
                                <div class="flex flex-col h-full">
                                    <!-- Search Bar -->
                                    <div class="p-3 border-b border-gray-200">
                                        <input type="text" id="emoji-search" placeholder="Search emojis..."
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>

                                    <!-- Categories -->
                                    <div class="flex border-b border-gray-200 overflow-x-auto" id="emoji-categories">
                                        <!-- Categories will be loaded here -->
                                    </div>

                                    <!-- Emoji Grid -->
                                    <div class="flex-1 overflow-y-auto p-3" id="emoji-grid">
                                        <!-- Emojis will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Message Input -->
                        <div class="flex-1 relative">
                            <input
                                type="text"
                                name="content"
                                id="message-input"
                                placeholder="{% if is_group %}Type a message to the group...{% else %}Type a message...{% endif %}"
                                class="w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                autocomplete="off"
                                autofocus
                            >
                        </div>

                        <!-- Send Button -->
                        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-full hover:bg-blue-700 transition duration-200 font-medium">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>

                    <!-- File Preview -->
                    <div id="file-preview" class="hidden mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-file text-gray-400 text-xl"></i>
                                <div>
                                    <p id="file-name" class="text-sm font-medium text-gray-900"></p>
                                    <p id="file-size" class="text-xs text-gray-500"></p>
                                </div>
                            </div>
                            <button type="button" onclick="clearFilePreview()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Media Modal -->
<div id="mediaModal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50 p-4">
    <div class="relative max-w-4xl max-h-full w-full">
        <button onclick="closeMediaModal()" class="absolute -top-12 right-0 text-white hover:text-gray-300 text-2xl z-10">
            <i class="fas fa-times"></i>
        </button>
        <div id="media-content" class="bg-transparent rounded-lg overflow-hidden">
            <!-- Media content will be inserted here -->
        </div>
    </div>
</div>

<!-- Edit Message Modal -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-96">
        <h3 class="text-lg font-semibold mb-4">Edit Message</h3>
        <textarea id="editMessageContent" class="w-full border border-gray-300 rounded-md p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
        <div class="flex justify-end space-x-3">
            <button onclick="closeEditModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-200">
                Cancel
            </button>
            <button onclick="saveEditedMessage()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200">
                Save Changes
            </button>
        </div>
    </div>
</div>

<!-- JavaScript for real-time chat and message actions -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const fileInput = document.getElementById('file-input');
    const filePreview = document.getElementById('file-preview');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const messagesList = document.getElementById('messages-list');
    const messagesContainer = document.getElementById('messages-container');
    const typingIndicator = document.getElementById('typing-indicator');
    const emptyState = document.getElementById('empty-state');
    const conversationId = '{{ conversation.id }}';

    let currentEditingMessageId = null;
    let selectedFile = null;

    // Scroll to bottom of messages
    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Remove empty state if messages exist
    if (messagesList.children.length > 0 && emptyState) {
        emptyState.remove();
    }

    // Scroll to bottom on page load
    scrollToBottom();

    // Handle file selection
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            selectedFile = file;
            showFilePreview(file);
        }
    });

    function showFilePreview(file) {
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        filePreview.classList.remove('hidden');
    }

    function clearFilePreview() {
        fileInput.value = '';
        selectedFile = null;
        filePreview.classList.add('hidden');
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Handle message form submission
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const content = messageInput.value.trim();
        const file = selectedFile;

        if (!content && !file) return;

        const formData = new FormData();
        formData.append('content', content);
        if (file) {
            formData.append('file', file);
        }

        // Send message via AJAX
        fetch(`/chat/${conversationId}/send-message/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                messageInput.value = '';
                clearFilePreview();

                // Remove empty state
                if (emptyState) {
                    emptyState.remove();
                }

                // Add message to the list
                addMessageToChat(data);

                // Stop typing indicator
                stopTyping();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => console.error('Error sending message:', error));
    });

    // Add message to chat
    function addMessageToChat(messageData) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-group flex justify-end';
        messageDiv.id = `message-${messageData.message_id}`;
        messageDiv.setAttribute('data-message-id', messageData.message_id);

        messageDiv.innerHTML = createMessageHTML(messageData, true);
        messagesList.appendChild(messageDiv);
        scrollToBottom();
    }

    // Add received message to chat
    function addReceivedMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-group flex justify-start';
        messageDiv.id = `message-${message.id}`;
        messageDiv.setAttribute('data-message-id', message.id);

        messageDiv.innerHTML = createMessageHTML(message, false);
        messagesList.appendChild(messageDiv);
        scrollToBottom();

        // Remove empty state
        if (emptyState) {
            emptyState.remove();
        }
    }

    // Create message HTML
    function createMessageHTML(message, isOwn) {
        const isGroup = {% if is_group %}true{% else %}false{% endif %};
        const isUnsent = message.is_unsent;

        let messageHTML = `
            <div class="message-bubble relative group max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${isOwn ? 'bg-blue-600 text-white' : 'bg-white border border-gray-200 text-gray-900'}">
        `;

        // Message header for group
        if (isGroup && !isOwn && !isUnsent) {
            messageHTML += `<p class="text-xs font-medium ${isOwn ? 'text-blue-100' : 'text-blue-600'} mb-1">${message.sender}</p>`;
        }

        // Message content
        if (isUnsent) {
            messageHTML += `<p class="text-sm italic opacity-70">This message was unsent</p>`;
        } else {
            if (message.message_type === 'text') {
                messageHTML += `<p class="text-sm message-content">${message.content}</p>`;
            } else if (message.message_type === 'emoji') {
                messageHTML += `
                    <div class="emoji-message text-4xl text-center py-2">
                        ${message.content}
                    </div>
                `;
            } else if (message.message_type === 'image') {
                messageHTML += `
                    <div class="mb-2">
                        <img src="${message.file_url}" alt="Shared image"
                             class="max-w-full h-auto rounded-lg cursor-pointer"
                             onclick="openMediaModal('${message.file_url}', 'image')">
                    </div>
                `;
                if (message.content) {
                    messageHTML += `<p class="text-sm message-content mt-2">${message.content}</p>`;
                }
            } else if (message.message_type === 'video') {
                messageHTML += `
                    <div class="mb-2">
                        <video controls class="max-w-full h-auto rounded-lg cursor-pointer"
                               onclick="openMediaModal('${message.file_url}', 'video')">
                            <source src="${message.file_url}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                `;
                if (message.content) {
                    messageHTML += `<p class="text-sm message-content mt-2">${message.content}</p>`;
                }
            } else if (message.message_type === 'audio') {
                messageHTML += `
                    <div class="mb-2">
                        <audio controls class="w-full">
                            <source src="${message.file_url}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                `;
                if (message.content) {
                    messageHTML += `<p class="text-sm message-content mt-2">${message.content}</p>`;
                }
            } else if (message.message_type === 'file') {
                messageHTML += `
                    <div class="mb-2 p-3 ${isOwn ? 'bg-white bg-opacity-20' : 'bg-gray-100'} rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0 w-10 h-10 ${isOwn ? 'bg-white bg-opacity-30' : 'bg-blue-100'} rounded-lg flex items-center justify-center">
                                <i class="fas fa-file ${isOwn ? 'text-white' : 'text-blue-600'}"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium ${isOwn ? 'text-white' : 'text-gray-900'} truncate">
                                    ${message.file_name || 'File'}
                                </p>
                                <p class="text-xs ${isOwn ? 'text-blue-100' : 'text-gray-500'}">
                                    ${message.file_size}
                                </p>
                            </div>
                            <a href="${message.file_url}" download
                               class="flex-shrink-0 p-2 ${isOwn ? 'bg-white bg-opacity-20 hover:bg-opacity-30' : 'bg-blue-100 hover:bg-blue-200'} rounded-lg transition duration-200"
                               title="Download file">
                                <i class="fas fa-download ${isOwn ? 'text-white' : 'text-blue-600'} text-sm"></i>
                            </a>
                        </div>
                    </div>
                `;
                if (message.content) {
                    messageHTML += `<p class="text-sm message-content mt-2">${message.content}</p>`;
                }
            }
        }

        // Message meta
        messageHTML += `
            <div class="flex items-center justify-between mt-1">
                <div class="flex items-center space-x-2">
                    <span class="text-xs opacity-70 ${isOwn ? 'text-blue-100' : 'text-gray-500'}">${message.timestamp}</span>
        `;

        if (message.is_edited && !isUnsent) {
            messageHTML += `<span class="text-xs opacity-70 ${isOwn ? 'text-blue-100' : 'text-gray-500'}">edited</span>`;
        }

        if (isOwn && !isUnsent) {
            messageHTML += `<i class="fas fa-check text-xs opacity-70 ${isOwn ? 'text-blue-100' : 'text-gray-500'}"></i>`;
        }

        messageHTML += `</div>`;

        // Reactions
        if (!isUnsent && message.reactions && Object.keys(message.reactions).length > 0) {
            messageHTML += `<div class="message-reactions flex space-x-1">`;
            for (const [emoji, count] of Object.entries(message.reactions)) {
                messageHTML += `<span class="text-xs ${isOwn ? 'bg-white bg-opacity-20' : 'bg-gray-100'} rounded-full px-1">${emoji} ${count}</span>`;
            }
            messageHTML += `</div>`;
        }

        messageHTML += `</div>`;

        // Message actions
        if (isOwn && !isUnsent) {
            messageHTML += `
                <div class="message-actions absolute -top-8 right-0 bg-white border border-gray-300 rounded-lg shadow-lg p-1 hidden group-hover:flex space-x-1">
            `;

            // Edit button only for text messages
            if (message.message_type === 'text') {
                messageHTML += `
                    <button onclick="editMessage('${message.id}')" class="p-1 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded transition duration-200" title="Edit message">
                        <i class="fas fa-edit text-xs"></i>
                    </button>
                `;
            }

            messageHTML += `
                    <button onclick="unsendMessage('${message.id}')" class="p-1 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition duration-200" title="Unsend message">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                    <div class="relative">
                        <button onclick="toggleReactions('${message.id}')" class="p-1 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded transition duration-200" title="Add reaction">
                            <i class="fas fa-smile text-xs"></i>
                        </button>
                        <div id="reactions-${message.id}" class="reaction-picker absolute bottom-full left-0 bg-white border border-gray-300 rounded-lg shadow-lg p-2 hidden grid grid-cols-3 gap-1 z-50">
                            ${createReactionButtons(message.id)}
                        </div>
                    </div>
                </div>
            `;
        } else if (!isUnsent) {
            messageHTML += `
                <div class="message-actions absolute -top-8 right-0 bg-white border border-gray-300 rounded-lg shadow-lg p-1 hidden group-hover:flex">
                    <div class="relative">
                        <button onclick="toggleReactions('${message.id}')" class="p-1 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded transition duration-200" title="Add reaction">
                            <i class="fas fa-smile text-xs"></i>
                        </button>
                        <div id="reactions-${message.id}" class="reaction-picker absolute bottom-full left-0 bg-white border border-gray-300 rounded-lg shadow-lg p-2 hidden grid grid-cols-3 gap-1 z-50">
                            ${createReactionButtons(message.id)}
                        </div>
                    </div>
                </div>
            `;
        }

        messageHTML += `</div>`;
        return messageHTML;
    }

    // Create reaction buttons HTML
    function createReactionButtons(messageId) {
        const emojis = ['ğŸ‘', 'â¤ï¸', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢', 'ğŸ˜¡'];
        return emojis.map(emoji =>
            `<button onclick="addReaction('${messageId}', '${emoji}')" class="p-1 hover:bg-gray-100 rounded text-lg transition duration-200">${emoji}</button>`
        ).join('');
    }

    // Set up periodic updates
    setInterval(checkForUpdates, 2000);

    // Update online status when page loads and when user becomes active
    updateOnlineStatus(true);

    window.addEventListener('focus', function() {
        updateOnlineStatus(true);
    });

    window.addEventListener('blur', function() {
        updateOnlineStatus(false);
    });
});

// Emoji Picker Functions
let currentEmojiCategory = 'smileys_people';

function toggleEmojiPicker() {
    const emojiPicker = document.getElementById('emoji-picker');
    emojiPicker.classList.toggle('hidden');

    if (!emojiPicker.classList.contains('hidden')) {
        loadEmojiCategories();
        loadEmojisByCategory('smileys_people');
    }
}

function loadEmojiCategories() {
    // Emoji categories data
    const categories = {
        'smileys_people': 'ğŸ˜€',
        'animals_nature': 'ğŸ¶',
        'food_drink': 'ğŸ',
        'activities': 'âš½',
        'travel_places': 'ğŸš—',
        'objects': 'ğŸ’¡',
        'symbols': 'â¤ï¸'
    };

    const categoriesContainer = document.getElementById('emoji-categories');
    let html = '';

    for (const category in categories) {
        html += `
            <button onclick="loadEmojisByCategory('${category}')"
                    class="flex-shrink-0 px-3 py-2 text-lg hover:bg-gray-100 ${currentEmojiCategory === category ? 'bg-blue-50 border-b-2 border-blue-500' : ''}">
                ${categories[category]}
            </button>
        `;
    }

    categoriesContainer.innerHTML = html;
}

function loadEmojisByCategory(category) {
    currentEmojiCategory = category;
    loadEmojiCategories(); // Update active category

    // Complete emoji data for all categories
    const emojiData = {
        'smileys_people': [
            'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š',
            'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£',
            'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—',
            'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¬', 'ğŸ™„', 'ğŸ˜¯', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜®', 'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤',
            'ğŸ¥´', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘', 'ğŸ¤ ', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ¤¡', 'ğŸ’©', 'ğŸ‘»', 'ğŸ’€', 'â˜ ï¸', 'ğŸ‘½', 'ğŸ‘¾',
            'ğŸ¤–', 'ğŸƒ', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿', 'ğŸ˜¾'
        ],
        'animals_nature': [
            'ğŸµ', 'ğŸ’', 'ğŸ¦', 'ğŸ¦§', 'ğŸ¶', 'ğŸ•', 'ğŸ¦®', 'ğŸ•â€ğŸ¦º', 'ğŸ©', 'ğŸº', 'ğŸ¦Š', 'ğŸ¦', 'ğŸ±', 'ğŸˆ', 'ğŸˆâ€â¬›', 'ğŸ¦', 'ğŸ¯', 'ğŸ…', 'ğŸ†', 'ğŸ´',
            'ğŸ', 'ğŸ¦„', 'ğŸ¦“', 'ğŸ¦Œ', 'ğŸ®', 'ğŸ‚', 'ğŸƒ', 'ğŸ„', 'ğŸ·', 'ğŸ–', 'ğŸ—', 'ğŸ½', 'ğŸ', 'ğŸ‘', 'ğŸ', 'ğŸª', 'ğŸ«', 'ğŸ¦™', 'ğŸ¦’', 'ğŸ˜',
            'ğŸ¦', 'ğŸ¦›', 'ğŸ­', 'ğŸ', 'ğŸ€', 'ğŸ¹', 'ğŸ°', 'ğŸ‡', 'ğŸ¿ï¸', 'ğŸ¦”', 'ğŸ¦‡', 'ğŸ»', 'ğŸ»â€â„ï¸', 'ğŸ¨', 'ğŸ¼', 'ğŸ¦¥', 'ğŸ¦¦', 'ğŸ¦¨', 'ğŸ¦˜', 'ğŸ¦¡',
            'ğŸ¾', 'ğŸ¦ƒ', 'ğŸ”', 'ğŸ“', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ§', 'ğŸ•Šï¸', 'ğŸ¦…', 'ğŸ¦†', 'ğŸ¦¢', 'ğŸ¦‰', 'ğŸ¦¤', 'ğŸª¶', 'ğŸ¦©', 'ğŸ¦š', 'ğŸ¦œ', 'ğŸ¸',
            'ğŸŠ', 'ğŸ¢', 'ğŸ¦', 'ğŸ', 'ğŸ²', 'ğŸ‰', 'ğŸ¦•', 'ğŸ¦–', 'ğŸ³', 'ğŸ‹', 'ğŸ¬', 'ğŸ¦­', 'ğŸŸ', 'ğŸ ', 'ğŸ¡', 'ğŸ¦ˆ', 'ğŸ™', 'ğŸš', 'ğŸŒ', 'ğŸ¦‹',
            'ğŸ›', 'ğŸœ', 'ğŸ', 'ğŸª²', 'ğŸ', 'ğŸ¦—', 'ğŸª³', 'ğŸ•·ï¸', 'ğŸ•¸ï¸', 'ğŸ¦‚', 'ğŸ¦Ÿ', 'ğŸª°', 'ğŸª±', 'ğŸ¦ ', 'ğŸ’', 'ğŸŒ¸', 'ğŸ’®', 'ğŸµï¸', 'ğŸŒ¹', 'ğŸ¥€',
            'ğŸŒº', 'ğŸŒ»', 'ğŸŒ¼', 'ğŸŒ·', 'ğŸŒ±', 'ğŸª´', 'ğŸŒ²', 'ğŸŒ³', 'ğŸŒ´', 'ğŸŒµ', 'ğŸŒ¾', 'ğŸŒ¿', 'â˜˜ï¸', 'ğŸ€', 'ğŸ', 'ğŸ‚', 'ğŸƒ'
        ],
        'food_drink': [
            'ğŸ‡', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ', 'ğŸ¥­', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ‘', 'ğŸ’', 'ğŸ“', 'ğŸ«', 'ğŸ¥', 'ğŸ…', 'ğŸ«’', 'ğŸ¥¥', 'ğŸ¥‘',
            'ğŸ†', 'ğŸ¥”', 'ğŸ¥•', 'ğŸŒ½', 'ğŸŒ¶ï¸', 'ğŸ«‘', 'ğŸ¥’', 'ğŸ¥¬', 'ğŸ¥¦', 'ğŸ§„', 'ğŸ§…', 'ğŸ„', 'ğŸ¥œ', 'ğŸŒ°', 'ğŸ', 'ğŸ¥', 'ğŸ¥–', 'ğŸ«“', 'ğŸ¥¨', 'ğŸ¥¯',
            'ğŸ¥', 'ğŸ§‡', 'ğŸ§€', 'ğŸ–', 'ğŸ—', 'ğŸ¥©', 'ğŸ¥“', 'ğŸ”', 'ğŸŸ', 'ğŸ•', 'ğŸŒ­', 'ğŸ¥ª', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸ«”', 'ğŸ¥™', 'ğŸ§†', 'ğŸ¥š', 'ğŸ³', 'ğŸ¥˜',
            'ğŸ²', 'ğŸ«•', 'ğŸ¥£', 'ğŸ¥—', 'ğŸ¿', 'ğŸ§ˆ', 'ğŸ§‚', 'ğŸ¥«', 'ğŸ±', 'ğŸ˜', 'ğŸ™', 'ğŸš', 'ğŸ›', 'ğŸœ', 'ğŸ', 'ğŸ ', 'ğŸ¢', 'ğŸ£', 'ğŸ¤', 'ğŸ¥',
            'ğŸ¥®', 'ğŸ¡', 'ğŸ¥Ÿ', 'ğŸ¥ ', 'ğŸ¥¡', 'ğŸ¦€', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦‘', 'ğŸ¦ª', 'ğŸ¦', 'ğŸ§', 'ğŸ¨', 'ğŸ©', 'ğŸª', 'ğŸ‚', 'ğŸ°', 'ğŸ§', 'ğŸ¥§', 'ğŸ«',
            'ğŸ¬', 'ğŸ­', 'ğŸ®', 'ğŸ¯', 'ğŸ¼', 'ğŸ¥›', 'â˜•', 'ğŸ«–', 'ğŸµ', 'ğŸ¶', 'ğŸ¾', 'ğŸ·', 'ğŸ¸', 'ğŸ¹', 'ğŸº', 'ğŸ»', 'ğŸ¥‚', 'ğŸ¥ƒ', 'ğŸ¥¤', 'ğŸ§‹',
            'ğŸ§ƒ', 'ğŸ§‰', 'ğŸ§Š', 'ğŸ¥¢', 'ğŸ½ï¸', 'ğŸ´', 'ğŸ¥„', 'ğŸ”ª', 'ğŸº'
        ],
        'activities': [
            'âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ±', 'ğŸª€', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ', 'ğŸªƒ', 'ğŸ¥…', 'â›³',
            'ğŸª', 'ğŸ¹', 'ğŸ£', 'ğŸ¤¿', 'ğŸ¥Š', 'ğŸ¥‹', 'ğŸ½', 'ğŸ›¹', 'ğŸ›¼', 'ğŸ›·', 'â›¸ï¸', 'ğŸ¥Œ', 'ğŸ¿', 'â›·ï¸', 'ğŸ‚', 'ğŸª‚', 'ğŸ‹ï¸', 'ğŸ¤¼', 'ğŸ¤¸', 'â›¹ï¸',
            'ğŸ¤¾', 'ğŸŒï¸', 'ğŸ‡', 'ğŸ§˜', 'ğŸ„', 'ğŸŠ', 'ğŸ¤½', 'ğŸš£', 'ğŸ§—', 'ğŸšµ', 'ğŸ¯', 'ğŸ®', 'ğŸ•¹ï¸', 'ğŸ²', 'ğŸ§©', 'ğŸ§¸', 'â™ ï¸', 'â™¥ï¸', 'â™¦ï¸', 'â™£ï¸',
            'â™Ÿï¸', 'ğŸƒ', 'ğŸ€„', 'ğŸ´', 'ğŸ­', 'ğŸ–¼ï¸', 'ğŸ¨', 'ğŸ§µ', 'ğŸª¡', 'ğŸ§¶', 'ğŸª¢', 'ğŸ‘“', 'ğŸ•¶ï¸', 'ğŸ¥½', 'ğŸ¥¼', 'ğŸ¦º', 'ğŸ‘”', 'ğŸ‘•', 'ğŸ‘–', 'ğŸ§£',
            'ğŸ§¤', 'ğŸ§¥', 'ğŸ§¦', 'ğŸ‘—', 'ğŸ‘˜', 'ğŸ¥»', 'ğŸ©±', 'ğŸ©²', 'ğŸ©³', 'ğŸ‘™', 'ğŸ‘š', 'ğŸ‘›', 'ğŸ‘œ', 'ğŸ‘', 'ğŸ’', 'ğŸ©´', 'ğŸ‘', 'ğŸ‘Ÿ', 'ğŸ¥¾', 'ğŸ¥¿',
            'ğŸ‘ ', 'ğŸ‘¡', 'ğŸ©°', 'ğŸ‘¢', 'ğŸ‘‘', 'ğŸ‘’', 'ğŸ©', 'ğŸ“', 'ğŸ§¢', 'ğŸª–', 'ğŸ’„', 'ğŸ’', 'ğŸ’¼'
        ],
        'travel_places': [
            'ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸšŒ', 'ğŸš', 'ğŸï¸', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš', 'ğŸ›»', 'ğŸšš', 'ğŸš›', 'ğŸšœ', 'ğŸï¸', 'ğŸ›µ', 'ğŸš²', 'ğŸ›´', 'ğŸ›¹', 'ğŸ›¼',
            'ğŸš', 'ğŸ›£ï¸', 'ğŸ›¤ï¸', 'â›½', 'ğŸš¨', 'ğŸš¥', 'ğŸš¦', 'ğŸ›‘', 'ğŸš§', 'âš“', 'â›µ', 'ğŸ›¶', 'ğŸš¤', 'ğŸ›³ï¸', 'â›´ï¸', 'ğŸ›¥ï¸', 'ğŸš¢', 'âœˆï¸', 'ğŸ›©ï¸', 'ğŸ›«',
            'ğŸ›¬', 'ğŸª‚', 'ğŸ’º', 'ğŸš', 'ğŸšŸ', 'ğŸš ', 'ğŸš¡', 'ğŸ›°ï¸', 'ğŸš€', 'ğŸ›¸', 'ğŸ›ï¸', 'ğŸ§³', 'âŒ›', 'â³', 'âŒš', 'â°', 'â±ï¸', 'â²ï¸', 'ğŸ•°ï¸', 'ğŸŒ¡ï¸',
            'ğŸ—ºï¸', 'ğŸ§­', 'ğŸ”ï¸', 'â›°ï¸', 'ğŸŒ‹', 'ğŸ—»', 'ğŸ•ï¸', 'ğŸ–ï¸', 'ğŸœï¸', 'ğŸï¸', 'ğŸï¸', 'ğŸŸï¸', 'ğŸ›ï¸', 'ğŸ—ï¸', 'ğŸ§±', 'ğŸª¨', 'ğŸªµ', 'ğŸ›–', 'ğŸ˜ï¸',
            'ğŸšï¸', 'ğŸ ', 'ğŸ¡', 'ğŸ¢', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ¨', 'ğŸ©', 'ğŸª', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ¯', 'ğŸ°', 'ğŸ’’', 'ğŸ—¼', 'ğŸ—½', 'â›ª',
            'ğŸ•Œ', 'ğŸ›•', 'ğŸ•', 'â›©ï¸', 'ğŸ•‹', 'âš›ï¸', 'ğŸ›', 'â˜®ï¸', 'âœï¸', 'â˜ªï¸', 'ğŸ•‰ï¸', 'â˜¸ï¸', 'âœ¡ï¸', 'ğŸ”¯', 'ğŸ•', 'â˜¯ï¸', 'â˜¦ï¸', 'ğŸ›'
        ],
        'objects': [
            'âŒš', 'ğŸ“±', 'ğŸ“²', 'ğŸ’»', 'âŒ¨ï¸', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'ğŸ–±ï¸', 'ğŸ–²ï¸', 'ğŸ•¹ï¸', 'ğŸ—œï¸', 'ğŸ’½', 'ğŸ’¾', 'ğŸ’¿', 'ğŸ“€', 'ğŸ“¼', 'ğŸ“·', 'ğŸ“¸', 'ğŸ“¹', 'ğŸ¥',
            'ğŸ“½ï¸', 'ğŸï¸', 'ğŸ“', 'â˜ï¸', 'ğŸ“Ÿ', 'ğŸ“ ', 'ğŸ“º', 'ğŸ“»', 'ğŸ™ï¸', 'ğŸšï¸', 'ğŸ›ï¸', 'ğŸ§­', 'â±ï¸', 'â²ï¸', 'â°', 'ğŸ•°ï¸', 'âŒ›', 'â³', 'ğŸ“¡', 'ğŸ”‹',
            'ğŸ”Œ', 'ğŸ’¡', 'ğŸ”¦', 'ğŸ•¯ï¸', 'ğŸª”', 'ğŸ§¯', 'ğŸ›¢ï¸', 'ğŸ’¸', 'ğŸ’µ', 'ğŸ’´', 'ğŸ’¶', 'ğŸ’·', 'ğŸ’°', 'ğŸ’³', 'ğŸ’', 'âš–ï¸', 'ğŸ§°', 'ğŸ”§', 'ğŸ”¨', 'âš’ï¸',
            'ğŸ› ï¸', 'â›ï¸', 'ğŸ”©', 'âš™ï¸', 'ğŸ§±', 'â›“ï¸', 'ğŸ§²', 'ğŸ”«', 'ğŸ’£', 'ğŸ§¨', 'ğŸª“', 'ğŸ”ª', 'ğŸ—¡ï¸', 'âš”ï¸', 'ğŸ›¡ï¸', 'ğŸš¬', 'âš°ï¸', 'âš±ï¸', 'ğŸº', 'ğŸ”®',
            'ğŸ“¿', 'ğŸ§¿', 'ğŸ’ˆ', 'âš—ï¸', 'ğŸ”­', 'ğŸ”¬', 'ğŸ•³ï¸', 'ğŸ©¹', 'ğŸ©º', 'ğŸ’Š', 'ğŸ’‰', 'ğŸ©¸', 'ğŸ§¬', 'ğŸ¦ ', 'ğŸ§«', 'ğŸ§ª', 'ğŸŒ¡ï¸', 'ğŸ§¹', 'ğŸ§º', 'ğŸ§»',
            'ğŸš½', 'ğŸš°', 'ğŸš¿', 'ğŸ›', 'ğŸ›€', 'ğŸ§¼', 'ğŸª’', 'ğŸ§½', 'ğŸ§´', 'ğŸ›ï¸', 'ğŸ”‘', 'ğŸ—ï¸', 'ğŸšª', 'ğŸª‘', 'ğŸ›‹ï¸', 'ğŸ›ï¸', 'ğŸ›Œ', 'ğŸ§¸', 'ğŸ–¼ï¸', 'ğŸ›ï¸',
            'ğŸ›’', 'ğŸ', 'ğŸˆ', 'ğŸ', 'ğŸ€', 'ğŸŠ', 'ğŸ‰', 'ğŸ', 'ğŸ®', 'ğŸ', 'âœ‰ï¸', 'ğŸ“©', 'ğŸ“¨', 'ğŸ“§', 'ğŸ’Œ', 'ğŸ“¥', 'ğŸ“¤', 'ğŸ“¦', 'ğŸ·ï¸', 'ğŸ“ª',
            'ğŸ“«', 'ğŸ“¬', 'ğŸ“­', 'ğŸ“®', 'ğŸ“¯', 'ğŸ“œ', 'ğŸ“ƒ', 'ğŸ“„', 'ğŸ“‘', 'ğŸ§¾', 'ğŸ“Š', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ—’ï¸', 'ğŸ—“ï¸', 'ğŸ“†', 'ğŸ“…', 'ğŸ—‘ï¸', 'ğŸ“‡', 'ğŸ—ƒï¸',
            'ğŸ—³ï¸', 'ğŸ—„ï¸', 'ğŸ“‹', 'ğŸ“', 'ğŸ“‚', 'ğŸ—‚ï¸', 'ğŸ—ï¸', 'ğŸ“°', 'ğŸ““', 'ğŸ“”', 'ğŸ“’', 'ğŸ“•', 'ğŸ“—', 'ğŸ“˜', 'ğŸ“™', 'ğŸ“š', 'ğŸ“–', 'ğŸ”–', 'ğŸ§·', 'ğŸ”—',
            'ğŸ“', 'ğŸ–‡ï¸', 'ğŸ“', 'ğŸ“', 'ğŸ§®', 'ğŸ“Œ', 'ğŸ“', 'âœ‚ï¸', 'ğŸ–Šï¸', 'ğŸ–‹ï¸', 'âœ’ï¸', 'ğŸ–Œï¸', 'ğŸ–ï¸', 'ğŸ“', 'âœï¸', 'ğŸ”', 'ğŸ”', 'ğŸ”', 'ğŸ”', 'ğŸ”’',
            'ğŸ”“'
        ],
        'symbols': [
            'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'â˜®ï¸',
            'âœï¸', 'â˜ªï¸', 'ğŸ•‰ï¸', 'â˜¸ï¸', 'âœ¡ï¸', 'ğŸ”¯', 'ğŸ•', 'â˜¯ï¸', 'â˜¦ï¸', 'ğŸ›', 'â›', 'â™ˆ', 'â™‰', 'â™Š', 'â™‹', 'â™Œ', 'â™', 'â™', 'â™', 'â™', 'â™‘',
            'â™’', 'â™“', 'ğŸ†”', 'âš›ï¸', 'ğŸ‰‘', 'â˜¢ï¸', 'â˜£ï¸', 'ğŸ“´', 'ğŸ“³', 'ğŸˆ¶', 'ğŸˆš', 'ğŸˆ¸', 'ğŸˆº', 'ğŸˆ·ï¸', 'âœ´ï¸', 'ğŸ†š', 'ğŸ’®', 'ğŸ‰', 'ãŠ™ï¸', 'ãŠ—ï¸',
            'ğŸˆ´', 'ğŸˆµ', 'ğŸˆ¹', 'ğŸˆ²', 'ğŸ…°ï¸', 'ğŸ…±ï¸', 'ğŸ†', 'ğŸ†‘', 'ğŸ…¾ï¸', 'ğŸ†˜', 'âŒ', 'â­•', 'ğŸ›‘', 'â›”', 'ğŸ“›', 'ğŸš«', 'ğŸ’¯', 'ğŸ’¢', 'â™¨ï¸', 'ğŸš·',
            'ğŸš¯', 'ğŸš³', 'ğŸš±', 'ğŸ”', 'ğŸ“µ', 'ğŸš­', 'â—', 'â•', 'â“', 'â”', 'â€¼ï¸', 'â‰ï¸', 'ğŸ”…', 'ğŸ”†', 'ã€½ï¸', 'âš ï¸', 'ğŸš¸', 'ğŸ”±', 'âšœï¸', 'ğŸ”°',
            'â™»ï¸', 'âœ…', 'ğŸˆ¯', 'ğŸ’¹', 'â‡ï¸', 'âœ³ï¸', 'â', 'ğŸŒ', 'ğŸ’ ', 'â“‚ï¸', 'ğŸŒ€', 'ğŸ’¤', 'ğŸ§', 'ğŸš¾', 'â™¿', 'ğŸ…¿ï¸', 'ğŸ›—', 'ğŸˆ³', 'ğŸˆ‚ï¸', 'ğŸ›‚',
            'ğŸ›ƒ', 'ğŸ›„', 'ğŸ›…', 'ğŸš¹', 'ğŸšº', 'ğŸš¼', 'ğŸš»', 'ğŸš®', 'ğŸ¦', 'ğŸ“¶', 'ğŸˆ', 'ğŸ”£', 'â„¹ï¸', 'ğŸ”¤', 'ğŸ”¡', 'ğŸ” ', 'ğŸ†–', 'ğŸ†—', 'ğŸ†™', 'ğŸ†’',
            'ğŸ†•', 'ğŸ†“', '0ï¸âƒ£', '1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ğŸ”Ÿ', 'ğŸ”¢', '#ï¸âƒ£', '*ï¸âƒ£', 'âï¸', 'â–¶ï¸', 'â¸ï¸', 'â¯ï¸',
            'â¹ï¸', 'âºï¸', 'â­ï¸', 'â®ï¸', 'â©', 'âª', 'â«', 'â¬', 'â—€ï¸', 'ğŸ”¼', 'ğŸ”½', 'â¡ï¸', 'â¬…ï¸', 'â¬†ï¸', 'â¬‡ï¸', 'â†—ï¸', 'â†˜ï¸', 'â†™ï¸', 'â†–ï¸', 'â†•ï¸',
            'â†”ï¸', 'â†ªï¸', 'â†©ï¸', 'â¤´ï¸', 'â¤µï¸', 'ğŸ”€', 'ğŸ”', 'ğŸ”‚', 'ğŸ”„', 'ğŸ”ƒ', 'ğŸµ', 'ğŸ¶', 'â•', 'â–', 'â—', 'â™¾ï¸', 'ğŸ’²', 'ğŸ’±', 'â„¢ï¸', 'Â©ï¸', 'Â®ï¸',
            'ã€°ï¸', 'â°', 'â¿', 'ğŸ”š', 'ğŸ”™', 'ğŸ”›', 'ğŸ”', 'ğŸ”œ'
        ]
    };

    const emojiGrid = document.getElementById('emoji-grid');
    const emojis = emojiData[category] || [];

    let html = '<div class="grid grid-cols-8 gap-2">';
    emojis.forEach(emojiChar => {
        html += `
            <button onclick="insertEmoji('${emojiChar}')"
                    class="text-xl p-2 hover:bg-gray-100 rounded-lg transition duration-200">
                ${emojiChar}
            </button>
        `;
    });
    html += '</div>';

    emojiGrid.innerHTML = html;
}

function searchEmojis() {
    const query = document.getElementById('emoji-search').value.toLowerCase();

    if (query.length === 0) {
        loadEmojisByCategory(currentEmojiCategory);
        return;
    }

    // All emojis for searching with descriptions
    const allEmojis = {
        'ğŸ˜€': 'grinning face', 'ğŸ˜ƒ': 'grinning face with big eyes', 'ğŸ˜„': 'grinning face with smiling eyes',
        'ğŸ˜': 'beaming face with smiling eyes', 'ğŸ˜†': 'grinning squinting face', 'ğŸ˜…': 'grinning face with sweat',
        'ğŸ˜‚': 'face with tears of joy', 'ğŸ¤£': 'rolling on the floor laughing', 'ğŸ˜Š': 'smiling face with smiling eyes',
        'ğŸ˜‡': 'smiling face with halo', 'ğŸ™‚': 'slightly smiling face', 'ğŸ™ƒ': 'upside-down face',
        'ğŸ˜‰': 'winking face', 'ğŸ˜Œ': 'relieved face', 'ğŸ˜': 'smiling face with heart-eyes',
        'ğŸ¥°': 'smiling face with hearts', 'ğŸ˜˜': 'face blowing a kiss', 'ğŸ˜—': 'kissing face',
        'ğŸ˜™': 'kissing face with smiling eyes', 'ğŸ˜š': 'kissing face with closed eyes', 'ğŸ˜‹': 'face savoring food',
        'ğŸ˜›': 'face with tongue', 'ğŸ˜': 'squinting face with tongue', 'ğŸ˜œ': 'winking face with tongue',
        'ğŸ¤ª': 'zany face', 'ğŸ¤¨': 'face with raised eyebrow', 'ğŸ§': 'face with monocle',
        'ğŸ¤“': 'nerd face', 'ğŸ˜': 'smiling face with sunglasses', 'ğŸ¤©': 'star-struck',
        'ğŸ¥³': 'partying face', 'ğŸ˜': 'smirking face', 'ğŸ˜’': 'unamused face',
        'ğŸ˜': 'disappointed face', 'ğŸ˜”': 'pensive face', 'ğŸ˜Ÿ': 'worried face',
        'ğŸ˜•': 'confused face', 'ğŸ™': 'slightly frowning face', 'â˜¹ï¸': 'frowning face',
        'ğŸ˜£': 'persevering face', 'ğŸ˜–': 'confounded face', 'ğŸ˜«': 'tired face',
        'ğŸ˜©': 'weary face', 'ğŸ¥º': 'pleading face', 'ğŸ˜¢': 'crying face',
        'ğŸ˜­': 'loudly crying face', 'ğŸ˜¤': 'face with steam from nose', 'ğŸ˜ ': 'angry face',
        'ğŸ˜¡': 'pouting face', 'ğŸ¤¬': 'face with symbols on mouth', 'ğŸ¤¯': 'exploding head',
        'ğŸ˜³': 'flushed face', 'ğŸ¥µ': 'hot face', 'ğŸ¥¶': 'cold face',
        'ğŸ˜±': 'face screaming in fear', 'ğŸ˜¨': 'fearful face', 'ğŸ˜°': 'anxious face with sweat',
        'ğŸ˜¥': 'sad but relieved face', 'ğŸ˜“': 'downcast face with sweat', 'ğŸ¤—': 'hugging face',
        'ğŸ¤”': 'thinking face', 'ğŸ¤­': 'face with hand over mouth', 'ğŸ¤«': 'shushing face',
        'ğŸ¤¥': 'lying face', 'ğŸ˜¶': 'face without mouth', 'ğŸ˜': 'neutral face',
        'ğŸ˜‘': 'expressionless face', 'ğŸ˜¬': 'grimacing face', 'ğŸ™„': 'face with rolling eyes',
        'ğŸ˜¯': 'hushed face', 'ğŸ˜¦': 'frowning face with open mouth', 'ğŸ˜§': 'anguished face',
        'ğŸ˜®': 'face with open mouth', 'ğŸ˜²': 'astonished face', 'ğŸ¥±': 'yawning face',
        'ğŸ˜´': 'sleeping face', 'ğŸ¤¤': 'drooling face', 'ğŸ˜ª': 'sleepy face',
        'ğŸ˜µ': 'dizzy face', 'ğŸ¤': 'face with medical mask', 'ğŸ¥´': 'woozy face',
        'ğŸ¤¢': 'nauseated face', 'ğŸ¤®': 'face vomiting', 'ğŸ¤§': 'sneezing face',
        'ğŸ˜·': 'face with medical mask', 'ğŸ¤’': 'face with thermometer', 'ğŸ¤•': 'face with head-bandage',
        'ğŸ¤‘': 'money-mouth face', 'ğŸ¤ ': 'cowboy hat face', 'ğŸ˜ˆ': 'smiling face with horns',
        'ğŸ‘¿': 'angry face with horns', 'ğŸ‘¹': 'ogre', 'ğŸ‘º': 'goblin',
        'ğŸ¤¡': 'clown face', 'ğŸ’©': 'pile of poo', 'ğŸ‘»': 'ghost',
        'ğŸ’€': 'skull', 'â˜ ï¸': 'skull and crossbones', 'ğŸ‘½': 'alien',
        'ğŸ‘¾': 'alien monster', 'ğŸ¤–': 'robot', 'ğŸƒ': 'jack-o-lantern',
        'ğŸµ': 'monkey face', 'ğŸ’': 'monkey', 'ğŸ¦': 'gorilla', 'ğŸ¦§': 'orangutan',
        'ğŸ¶': 'dog face', 'ğŸ•': 'dog', 'ğŸ¦®': 'guide dog', 'ğŸ•â€ğŸ¦º': 'service dog',
        'ğŸ©': 'poodle', 'ğŸº': 'wolf', 'ğŸ¦Š': 'fox', 'ğŸ¦': 'raccoon',
        'ğŸ±': 'cat face', 'ğŸˆ': 'cat', 'ğŸˆâ€â¬›': 'black cat', 'ğŸ¦': 'lion',
        'ğŸ¯': 'tiger face', 'ğŸ…': 'tiger', 'ğŸ†': 'leopard', 'ğŸ´': 'horse face',
        'ğŸ': 'horse', 'ğŸ¦„': 'unicorn', 'ğŸ¦“': 'zebra', 'ğŸ¦Œ': 'deer',
        'ğŸ®': 'cow face', 'ğŸ‚': 'ox', 'ğŸƒ': 'water buffalo', 'ğŸ„': 'cow',
        'ğŸ·': 'pig face', 'ğŸ–': 'pig', 'ğŸ—': 'boar', 'ğŸ½': 'pig nose',
        'ğŸ': 'ram', 'ğŸ‘': 'ewe', 'ğŸ': 'goat', 'ğŸª': 'camel',
        'ğŸ«': 'two-hump camel', 'ğŸ¦™': 'llama', 'ğŸ¦’': 'giraffe', 'ğŸ˜': 'elephant',
        'ğŸ¦': 'rhinoceros', 'ğŸ¦›': 'hippopotamus', 'ğŸ­': 'mouse face', 'ğŸ': 'mouse',
        'ğŸ€': 'rat', 'ğŸ¹': 'hamster', 'ğŸ°': 'rabbit face', 'ğŸ‡': 'rabbit',
        'ğŸ¿ï¸': 'chipmunk', 'ğŸ¦”': 'hedgehog', 'ğŸ¦‡': 'bat', 'ğŸ»': 'bear',
        'ğŸ»â€â„ï¸': 'polar bear', 'ğŸ¨': 'koala', 'ğŸ¼': 'panda', 'ğŸ¦¥': 'sloth',
        'ğŸ¦¦': 'otter', 'ğŸ¦¨': 'skunk', 'ğŸ¦˜': 'kangaroo', 'ğŸ¦¡': 'badger',
        'ğŸ¾': 'paw prints', 'ğŸ¦ƒ': 'turkey', 'ğŸ”': 'chicken', 'ğŸ“': 'rooster',
        'ğŸ£': 'hatching chick', 'ğŸ¤': 'baby chick', 'ğŸ¥': 'front-facing baby chick',
        'ğŸ¦': 'bird', 'ğŸ§': 'penguin', 'ğŸ•Šï¸': 'dove', 'ğŸ¦…': 'eagle',
        'ğŸ¦†': 'duck', 'ğŸ¦¢': 'swan', 'ğŸ¦‰': 'owl', 'ğŸ¦¤': 'dodo',
        'ğŸª¶': 'feather', 'ğŸ¦©': 'flamingo', 'ğŸ¦š': 'peacock', 'ğŸ¦œ': 'parrot',
        'ğŸ¸': 'frog', 'ğŸŠ': 'crocodile', 'ğŸ¢': 'turtle', 'ğŸ¦': 'lizard',
        'ğŸ': 'snake', 'ğŸ²': 'dragon face', 'ğŸ‰': 'dragon', 'ğŸ¦•': 'sauropod',
        'ğŸ¦–': 't-rex', 'ğŸ³': 'spouting whale', 'ğŸ‹': 'whale', 'ğŸ¬': 'dolphin',
        'ğŸ¦­': 'seal', 'ğŸŸ': 'fish', 'ğŸ ': 'tropical fish', 'ğŸ¡': 'blowfish',
        'ğŸ¦ˆ': 'shark', 'ğŸ™': 'octopus', 'ğŸš': 'spiral shell', 'ğŸŒ': 'snail',
        'ğŸ¦‹': 'butterfly', 'ğŸ›': 'bug', 'ğŸœ': 'ant', 'ğŸ': 'honeybee',
        'ğŸª²': 'beetle', 'ğŸ': 'lady beetle', 'ğŸ¦—': 'cricket', 'ğŸª³': 'cockroach',
        'ğŸ•·ï¸': 'spider', 'ğŸ•¸ï¸': 'spider web', 'ğŸ¦‚': 'scorpion', 'ğŸ¦Ÿ': 'mosquito',
        'ğŸª°': 'fly', 'ğŸª±': 'worm', 'ğŸ¦ ': 'microbe', 'ğŸ’': 'bouquet',
        'ğŸŒ¸': 'cherry blossom', 'ğŸ’®': 'white flower', 'ğŸµï¸': 'rosette',
        'ğŸŒ¹': 'rose', 'ğŸ¥€': 'wilted flower', 'ğŸŒº': 'hibiscus',
        'ğŸŒ»': 'sunflower', 'ğŸŒ¼': 'blossom', 'ğŸŒ·': 'tulip',
        'ğŸŒ±': 'seedling', 'ğŸª´': 'potted plant', 'ğŸŒ²': 'evergreen tree',
        'ğŸŒ³': 'deciduous tree', 'ğŸŒ´': 'palm tree', 'ğŸŒµ': 'cactus',
        'ğŸŒ¾': 'sheaf of rice', 'ğŸŒ¿': 'herb', 'â˜˜ï¸': 'shamrock',
        'ğŸ€': 'four leaf clover', 'ğŸ': 'maple leaf', 'ğŸ‚': 'fallen leaf',
        'ğŸƒ': 'leaf fluttering in wind'
    };

    const emojiGrid = document.getElementById('emoji-grid');
    const results = [];

    for (const [emojiChar, description] of Object.entries(allEmojis)) {
        if (description.includes(query)) {
            results.push(emojiChar);
        }
        if (results.length >= 48) break; // Limit results to fit grid
    }

    if (results.length === 0) {
        emojiGrid.innerHTML = '<p class="text-center text-gray-500 py-4">No emojis found</p>';
        return;
    }

    let html = '<div class="grid grid-cols-8 gap-2">';
    results.forEach(emojiChar => {
        html += `
            <button onclick="insertEmoji('${emojiChar}')"
                    class="text-xl p-2 hover:bg-gray-100 rounded-lg transition duration-200">
                ${emojiChar}
            </button>
        `;
    });
    html += '</div>';

    emojiGrid.innerHTML = html;
}

function insertEmoji(emojiChar) {
    const messageInput = document.getElementById('message-input');
    const currentValue = messageInput.value;
    const cursorPosition = messageInput.selectionStart;

    messageInput.value = currentValue.substring(0, cursorPosition) + emojiChar + currentValue.substring(cursorPosition);
    messageInput.focus();
    messageInput.selectionStart = cursorPosition + emojiChar.length;
    messageInput.selectionEnd = cursorPosition + emojiChar.length;

    // Close emoji picker
    document.getElementById('emoji-picker').classList.add('hidden');

    // Trigger input event for typing indicator
    messageInput.dispatchEvent(new Event('input'));
}

// Close emoji picker when clicking outside
document.addEventListener('click', function(event) {
    const emojiPicker = document.getElementById('emoji-picker');
    const emojiButton = event.target.closest('button[onclick*="toggleEmojiPicker"]');

    if (emojiPicker && !emojiPicker.contains(event.target) && !emojiButton) {
        emojiPicker.classList.add('hidden');
    }
});

// Search emojis on input
document.getElementById('emoji-search').addEventListener('input', searchEmojis);

// Media Modal Functions
function openMediaModal(url, type) {
    const modal = document.getElementById('mediaModal');
    const content = document.getElementById('media-content');

    if (type === 'image') {
        content.innerHTML = `<img src="${url}" alt="Shared image" class="w-full h-auto max-h-screen object-contain">`;
    } else if (type === 'video') {
        content.innerHTML = `
            <video controls autoplay class="w-full h-auto max-h-screen">
                <source src="${url}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        `;
    }

    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeMediaModal() {
    const modal = document.getElementById('mediaModal');
    const content = document.getElementById('media-content');

    // Stop video playback
    const video = content.querySelector('video');
    if (video) {
        video.pause();
    }

    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
    content.innerHTML = '';
}

// Close modal when clicking on background
document.getElementById('mediaModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeMediaModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeMediaModal();
    }
});

// Message Action Functions
function editMessage(messageId) {
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    const contentElement = messageElement.querySelector('.message-content');

    document.getElementById('editMessageContent').value = contentElement.textContent;
    document.getElementById('editModal').classList.remove('hidden');
    currentEditingMessageId = messageId;
}

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
    currentEditingMessageId = null;
}

function saveEditedMessage() {
    if (!currentEditingMessageId) return;

    const newContent = document.getElementById('editMessageContent').value.trim();
    if (!newContent) return;

    fetch(`/chat/message/${currentEditingMessageId}/edit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ content: newContent })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const messageElement = document.querySelector(`[data-message-id="${currentEditingMessageId}"]`);
            const contentElement = messageElement.querySelector('.message-content');
            contentElement.textContent = data.new_content;

            // Add edited indicator if not exists
            const metaElement = messageElement.querySelector('.flex.items-center.space-x-2');
            if (!metaElement.querySelector('.edited-indicator')) {
                const editedSpan = document.createElement('span');
                editedSpan.className = 'text-xs opacity-70 edited-indicator';
                editedSpan.textContent = 'edited';
                metaElement.appendChild(editedSpan);
            }

            closeEditModal();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error editing message');
    });
}

function unsendMessage(messageId) {
    if (!confirm('Are you sure you want to unsend this message? This cannot be undone.')) {
        return;
    }

    fetch(`/chat/message/${messageId}/unsend/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            const contentElement = messageElement.querySelector('.message-content');
            contentElement.innerHTML = '<p class="text-sm italic opacity-70">This message was unsent</p>';

            // Hide message actions
            const actionsElement = messageElement.querySelector('.message-actions');
            if (actionsElement) {
                actionsElement.remove();
            }

            // Hide reactions
            const reactionsElement = messageElement.querySelector('.message-reactions');
            if (reactionsElement) {
                reactionsElement.innerHTML = '';
            }
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error unsending message');
    });
}

function toggleReactions(messageId) {
    const reactionsPicker = document.getElementById(`reactions-${messageId}`);
    reactionsPicker.classList.toggle('hidden');

    // Close other reaction pickers
    document.querySelectorAll('.reaction-picker').forEach(picker => {
        if (picker.id !== `reactions-${messageId}`) {
            picker.classList.add('hidden');
        }
    });
}

function addReaction(messageId, emoji) {
    fetch(`/chat/message/${messageId}/react/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ reaction: emoji })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateReactionsDisplay(messageId, data.reactions);
            toggleReactions(messageId); // Close picker
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding reaction');
    });
}

function updateReactionsDisplay(messageId, reactions) {
    const reactionsContainer = document.querySelector(`[data-message-id="${messageId}"] .message-reactions`);
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    const isOwn = messageElement.classList.contains('justify-end');

    if (!reactionsContainer) return;

    if (Object.keys(reactions).length === 0) {
        reactionsContainer.innerHTML = '';
        return;
    }

    let html = '';
    for (const [emoji, count] of Object.entries(reactions)) {
        html += `<span class="text-xs ${isOwn ? 'bg-white bg-opacity-20' : 'bg-gray-100'} rounded-full px-1">${emoji} ${count}</span>`;
    }

    reactionsContainer.innerHTML = html;
}

// Close reaction pickers when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.reaction-picker') && !event.target.closest('[onclick*="toggleReactions"]')) {
        document.querySelectorAll('.reaction-picker').forEach(picker => {
            picker.classList.add('hidden');
        });
    }
});

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function checkForUpdates() {
    const conversationId = '{{ conversation.id }}';

    // Check for new messages
    fetch(`/chat/${conversationId}/new-messages/`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.has_new_messages) {
                data.new_messages.forEach(message => {
                    // Check if message already exists
                    if (!document.querySelector(`[data-message-id="${message.id}"]`)) {
                        addReceivedMessage(message);
                    }
                });
            }
        });

    // Check typing status
    fetch(`/chat/${conversationId}/typing-status/`)
        .then(response => response.json())
        .then(data => {
            if (data.is_typing && data.typing_users.length > 0) {
                showTypingIndicator(data.typing_users);
            } else {
                hideTypingIndicator();
            }
        });

    // Update message status and reactions
    fetch(`/chat/${conversationId}/get-messages/`)
        .then(response => response.json())
        .then(data => {
            if (data.messages) {
                data.messages.forEach(message => {
                    const existingMessage = document.querySelector(`[data-message-id="${message.id}"]`);
                    if (existingMessage) {
                        // Update reactions
                        updateReactionsDisplay(message.id, message.reactions);

                        // Update read status
                        if (message.is_own && message.is_read) {
                            const checkIcon = existingMessage.querySelector('.fa-check');
                            if (checkIcon) {
                                checkIcon.className = 'fas fa-check-double text-xs opacity-70 text-blue-100';
                            }
                        }
                    }
                });
            }
        });
}

function showTypingIndicator(typingUsers) {
    const typingText = document.getElementById('typing-text');
    if (typingUsers.length === 1) {
        typingText.textContent = `${typingUsers[0]} is typing...`;
    } else if (typingUsers.length === 2) {
        typingText.textContent = `${typingUsers[0]} and ${typingUsers[1]} are typing...`;
    } else {
        typingText.textContent = 'Several people are typing...';
    }
    typingIndicator.classList.remove('hidden');
    scrollToBottom();
}

function hideTypingIndicator() {
    typingIndicator.classList.add('hidden');
}

function updateOnlineStatus(online) {
    fetch('/chat/update-online-status/', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: new URLSearchParams({
            'online': online.toString()
        })
    });
}

// Typing indicator functionality
let typingTimer;
const TYPING_TIMEOUT = 3000;

document.getElementById('message-input').addEventListener('input', function() {
    startTyping();

    // Clear existing timer
    clearTimeout(typingTimer);

    // Set new timer to stop typing
    typingTimer = setTimeout(stopTyping, TYPING_TIMEOUT);
});

function startTyping() {
    const conversationId = '{{ conversation.id }}';
    fetch(`/chat/${conversationId}/typing/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            is_typing: true
        })
    });
}

function stopTyping() {
    const conversationId = '{{ conversation.id }}';
    fetch(`/chat/${conversationId}/typing/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            is_typing: false
        })
    });
}

function scrollToBottom() {
    const messagesContainer = document.getElementById('messages-container');
    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
}
</script>

<style>
.emoji-message {
    line-height: 1.2;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

#emoji-picker {
    backdrop-filter: blur(10px);
}

#emoji-grid::-webkit-scrollbar {
    width: 6px;
}

#emoji-grid::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#emoji-grid::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#emoji-grid::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
{% endblock %}