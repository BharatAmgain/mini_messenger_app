<!-- templates/chat/conversation.html -->
{% extends 'base.html' %}
{% load static %}
{% load chat_filters %}

{% block title %}{% if is_group %}{{ conversation.group_name }} - Group Chat{% else %}Chat with {{ other_user.username }}{% endif %} - Messenger{% endblock %}

{% block mobile_title %}
{% if is_group %}{{ conversation.group_name }}{% else %}{{ other_user.username }}{% endif %}
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 flex flex-col mobile-chat-container"
     style="height: 100vh; max-height: -webkit-fill-available;">
    <!-- Chat Header -->
    <div class="bg-white border-b border-gray-200 p-4 sticky top-0 z-30 md:relative mobile-chat-header">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <!-- Back Button (Mobile) -->
                <a href="{% url 'chat_home' %}" class="md:hidden text-gray-600 mobile-back-btn">
                    <i class="fas fa-arrow-left text-lg"></i>
                </a>

                {% if is_group %}
                    {% if conversation.group_photo %}
                    <img src="{{ conversation.group_photo.url }}" alt="{{ conversation.group_name }}"
                         class="w-10 h-10 rounded-full object-cover">
                    {% else %}
                    <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center">
                        <i class="fas fa-users text-white"></i>
                    </div>
                    {% endif %}
                    <div class="flex-1 min-w-0">
                        <h2 class="font-semibold text-gray-900 truncate">{{ conversation.group_name }}</h2>
                        <p class="text-sm text-gray-600">{{ group_members.count }} members</p>
                    </div>
                {% else %}
                    {% if other_user.profile_picture %}
                    <img src="{{ other_user.profile_picture.url }}" alt="{{ other_user.username }}"
                         class="w-10 h-10 rounded-full object-cover">
                    {% else %}
                    <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
                        <i class="fas fa-user text-gray-500"></i>
                    </div>
                    {% endif %}
                    <div class="flex-1 min-w-0">
                        <h2 class="font-semibold text-gray-900 truncate">{{ other_user.username }}</h2>
                        <div class="flex items-center space-x-1">
                            {% if other_user.status.online %}
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <p class="text-sm text-gray-600">Online</p>
                            {% else %}
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            <p class="text-sm text-gray-600">Offline</p>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>

            <div class="flex items-center space-x-2">
                {% if is_group %}
                <a href="{% url 'group_settings' conversation.id %}"
                   class="p-2 text-gray-600 hover:text-gray-900 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-cog"></i>
                </a>
                {% endif %}

                <!-- Mobile Menu Button -->
                <div class="relative md:hidden">
                    <button id="chat-menu-btn" class="p-2 text-gray-600 hover:text-gray-900 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>

                    <!-- Mobile Chat Menu -->
                    <div id="chat-menu" class="absolute right-0 top-12 bg-white border border-gray-200 rounded-lg shadow-lg py-2 hidden z-50">
                        {% if is_group %}
                        <form method="POST" action="{% url 'leave_group' conversation.id %}"
                              onsubmit="return confirm('Are you sure you want to leave this group?');">
                            {% csrf_token %}
                            <button type="submit" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 text-sm">
                                <i class="fas fa-sign-out-alt mr-2"></i>Leave Group
                            </button>
                        </form>
                        {% else %}
                        <button type="button" onclick="blockUser()" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 text-sm">
                            <i class="fas fa-user-slash mr-2"></i>Block User
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Area -->
    <div class="flex-1 overflow-y-auto p-4 bg-gray-50 custom-scrollbar mobile-messages-area"
         id="messages-container">
        <div class="space-y-3" id="messages-list">
            {% for message in messages %}
            <div class="message-group flex {% if message.sender == request.user %}justify-end{% else %}justify-start{% endif %}"
                 data-message-id="{{ message.id }}">

                <div class="message-bubble relative group max-w-xs lg:max-w-md px-4 py-2 rounded-lg {% if message.sender == request.user %}bg-blue-600 text-white{% else %}bg-white border border-gray-200 text-gray-900{% endif %}">

                    <!-- Message Header for Group -->
                    {% if is_group and message.sender != request.user and not message.is_unsent %}
                    <p class="text-xs font-medium {% if message.sender == request.user %}text-blue-100{% else %}text-blue-600{% endif %} mb-1">
                        {{ message.sender.username }}
                    </p>
                    {% endif %}

                    <!-- Message Content -->
                    {% if message.is_unsent %}
                    <p class="text-sm italic opacity-70">This message was unsent</p>
                    {% else %}
                        {% if message.message_type == 'text' %}
                        <p class="text-sm message-content">{{ message.content }}</p>
                        {% elif message.message_type == 'emoji' %}
                        <div class="emoji-message text-4xl text-center py-2">
                            {{ message.content }}
                        </div>
                        {% elif message.message_type == 'image' %}
                        <div class="mb-2">
                            <img src="{{ message.file.url }}" alt="Shared image"
                                 class="max-w-full h-auto rounded-lg cursor-pointer mobile-media"
                                 onclick="openMediaModal('{{ message.file.url }}', 'image')">
                        </div>
                        {% if message.content %}
                        <p class="text-sm message-content mt-2">{{ message.content }}</p>
                        {% endif %}
                        {% elif message.message_type == 'video' %}
                        <div class="mb-2">
                            <video controls class="max-w-full h-auto rounded-lg cursor-pointer mobile-media"
                                   onclick="openMediaModal('{{ message.file.url }}', 'video')">
                                <source src="{{ message.file.url }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                        {% if message.content %}
                        <p class="text-sm message-content mt-2">{{ message.content }}</p>
                        {% endif %}
                        {% elif message.message_type == 'audio' %}
                        <div class="mb-2">
                            <audio controls class="w-full mobile-audio">
                                <source src="{{ message.file.url }}" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                        {% if message.content %}
                        <p class="text-sm message-content mt-2">{{ message.content }}</p>
                        {% endif %}
                        {% elif message.message_type == 'file' %}
                        <div class="mb-2 p-3 bg-{% if message.sender == request.user %}white bg-opacity-20{% else %}gray-100{% endif %} rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0 w-10 h-10 bg-{% if message.sender == request.user %}white bg-opacity-30{% else %}blue-100{% endif %} rounded-lg flex items-center justify-center">
                                    <i class="fas fa-file {% if message.sender == request.user %}text-white{% else %}text-blue-600{% endif %}"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium {% if message.sender == request.user %}text-white{% else %}text-gray-900{% endif %} truncate">
                                        {{ message.file_name|default:"File" }}
                                    </p>
                                    <p class="text-xs {% if message.sender == request.user %}text-blue-100{% else %}text-gray-500{% endif %}">
                                        {{ message.get_file_size_display }}
                                    </p>
                                </div>
                                <a href="{{ message.file.url }}" download
                                   class="flex-shrink-0 p-2 {% if message.sender == request.user %}bg-white bg-opacity-20 hover:bg-opacity-30{% else %}bg-blue-100 hover:bg-blue-200{% endif %} rounded-lg transition duration-200"
                                   title="Download file">
                                    <i class="fas fa-download {% if message.sender == request.user %}text-white{% else %}text-blue-600{% endif %} text-sm"></i>
                                </a>
                            </div>
                        </div>
                        {% if message.content %}
                        <p class="text-sm message-content mt-2">{{ message.content }}</p>
                        {% endif %}
                        {% endif %}
                    {% endif %}

                    <!-- Message Meta -->
                    <div class="flex items-center justify-between mt-1">
                        <div class="flex items-center space-x-2">
                            <span class="text-xs opacity-70 {% if message.sender == request.user %}text-blue-100{% else %}text-gray-500{% endif %}">
                                {{ message.timestamp|time }}
                            </span>

                            {% if message.is_edited and not message.is_unsent %}
                            <span class="text-xs opacity-70 {% if message.sender == request.user %}text-blue-100{% else %}text-gray-500{% endif %}">
                                edited
                            </span>
                            {% endif %}

                            {% if message.sender == request.user and not message.is_unsent %}
                                {% if message.is_read %}
                                <i class="fas fa-check-double text-xs opacity-70 {% if message.sender == request.user %}text-blue-100{% else %}text-gray-500{% endif %}"></i>
                                {% else %}
                                <i class="fas fa-check text-xs opacity-70 {% if message.sender == request.user %}text-blue-100{% else %}text-gray-500{% endif %}"></i>
                                {% endif %}
                            {% endif %}
                        </div>

                        <!-- Reactions -->
                        {% if not message.is_unsent %}
                        <div class="message-reactions flex space-x-1">
                            {% for emoji, count in message.get_reaction_summary.items %}
                            <span class="text-xs {% if message.sender == request.user %}bg-white bg-opacity-20{% else %}bg-gray-100{% endif %} rounded-full px-1">
                                {{ emoji }} {{ count }}
                            </span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Message Actions (hover menu) -->
                    {% if message.sender == request.user and not message.is_unsent %}
                    <div class="message-actions absolute -top-8 right-0 bg-white border border-gray-300 rounded-lg shadow-lg p-1 hidden group-hover:flex space-x-1">
                        <!-- Edit Button (only for text messages) -->
                        {% if message.message_type == 'text' %}
                        <button onclick="editMessage('{{ message.id }}')"
                                class="p-1 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded transition duration-200"
                                title="Edit message">
                            <i class="fas fa-edit text-xs"></i>
                        </button>
                        {% endif %}

                        <!-- Unsend Button -->
                        <button onclick="unsendMessage('{{ message.id }}')"
                                class="p-1 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition duration-200"
                                title="Unsend message">
                            <i class="fas fa-trash text-xs"></i>
                        </button>

                        <!-- React Button -->
                        <div class="relative">
                            <button onclick="toggleReactions('{{ message.id }}')"
                                    class="p-1 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded transition duration-200"
                                    title="Add reaction">
                                <i class="fas fa-smile text-xs"></i>
                            </button>

                            <!-- Reaction Picker -->
                            <div id="reactions-{{ message.id }}" class="reaction-picker absolute bottom-full left-0 bg-white border border-gray-300 rounded-lg shadow-lg p-2 hidden grid grid-cols-3 gap-1 z-50">
                                {% for emoji in 'ğŸ‘,â¤ï¸,ğŸ˜‚,ğŸ˜®,ğŸ˜¢,ğŸ˜¡'|split:',' %}
                                <button onclick="addReaction('{{ message.id }}', '{{ emoji }}')"
                                        class="p-1 hover:bg-gray-100 rounded text-lg transition duration-200 mobile-reaction-btn">
                                    {{ emoji }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% elif not message.is_unsent %}
                    <!-- React button for others' messages -->
                    <div class="message-actions absolute -top-8 right-0 bg-white border border-gray-300 rounded-lg shadow-lg p-1 hidden group-hover:flex">
                        <div class="relative">
                            <button onclick="toggleReactions('{{ message.id }}')"
                                    class="p-1 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded transition duration-200"
                                    title="Add reaction">
                                <i class="fas fa-smile text-xs"></i>
                            </button>

                            <div id="reactions-{{ message.id }}" class="reaction-picker absolute bottom-full left-0 bg-white border border-gray-300 rounded-lg shadow-lg p-2 hidden grid grid-cols-3 gap-1 z-50">
                                {% for emoji in 'ğŸ‘,â¤ï¸,ğŸ˜‚,ğŸ˜®,ğŸ˜¢,ğŸ˜¡'|split:',' %}
                                <button onclick="addReaction('{{ message.id }}', '{{ emoji }}')"
                                        class="p-1 hover:bg-gray-100 rounded text-lg transition duration-200 mobile-reaction-btn">
                                    {{ emoji }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="text-center py-8" id="empty-state">
                <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-comments text-gray-400 text-xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No messages yet</h3>
                <p class="text-gray-600">
                    {% if is_group %}
                        Start the conversation in your group!
                    {% else %}
                        Send a message to start the conversation.
                    {% endif %}
                </p>
            </div>
            {% endfor %}
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" class="hidden flex justify-start mt-4">
            <div class="max-w-xs px-4 py-2 rounded-lg bg-white border border-gray-200">
                <div class="flex space-x-1">
                    <div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div>
                    <div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div>
                    <div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div>
                </div>
                <p class="text-xs text-gray-500 mt-1" id="typing-text">
                    {% if is_group %}
                        Someone is typing...
                    {% else %}
                        {{ other_user.username }} is typing...
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Enhanced Mobile Message Input -->
    <div class="bg-white border-t border-gray-200 p-3 mobile-input-container">
        <form method="POST" class="flex items-end space-x-2" id="message-form"
              action="{% url 'conversation' conversation.id %}" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- File Upload -->
            <div class="relative">
                <input type="file" id="file-input" name="file"
                       accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip" class="hidden mobile-file-input">
                <button type="button" onclick="openFilePicker()"
                        class="p-2 text-gray-600 hover:text-blue-600 rounded-full transition duration-200 mobile-attach-btn">
                    <i class="fas fa-paperclip text-lg"></i>
                </button>
            </div>

            <!-- Enhanced Emoji Picker -->
            <div class="relative flex-1">
                <div class="flex items-end space-x-2 mobile-input-row">
                    <!-- Emoji Button -->
                    <button type="button" onclick="toggleEmojiPicker()"
                            class="p-2 text-gray-600 hover:text-yellow-500 rounded-full transition duration-200 flex-shrink-0 mobile-emoji-btn">
                        <i class="fas fa-smile text-lg"></i>
                    </button>

                    <!-- Message Input -->
                    <div class="flex-1 relative">
                        <textarea
                            id="message-input"
                            name="content"
                            placeholder="{% if is_group %}Type a message...{% else %}Type a message...{% endif %}"
                            class="w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none mobile-message-input"
                            rows="1"
                            style="max-height: 120px; min-height: 48px;"
                            oninput="autoResize(this)"></textarea>
                    </div>

                    <!-- Send Button -->
                    <button type="submit"
                            class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700 transition duration-200 flex-shrink-0 mobile-send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>

                <!-- Enhanced Mobile Emoji Picker -->
                <div id="emoji-picker"
                     class="absolute bottom-14 left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-xl hidden z-50 emoji-picker-mobile">
                    <div class="flex flex-col h-full">
                        <!-- Search -->
                        <div class="p-3 border-b border-gray-200">
                            <input type="text" id="emoji-search" placeholder="Search emojis..."
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- Categories -->
                        <div class="flex border-b border-gray-200 overflow-x-auto bg-gray-50" id="emoji-categories">
                            <!-- Categories loaded via JS -->
                        </div>

                        <!-- Emoji Grid -->
                        <div class="flex-1 overflow-y-auto p-3" id="emoji-grid">
                            <!-- Emojis loaded via JS -->
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <!-- File Preview -->
        <div id="file-preview" class="hidden mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-file text-gray-400 text-xl"></i>
                    <div>
                        <p id="file-name" class="text-sm font-medium text-gray-900"></p>
                        <p id="file-size" class="text-xs text-gray-500"></p>
                    </div>
                </div>
                <button type="button" onclick="clearFilePreview()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Media Modal -->
<div id="mediaModal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50 p-4">
    <div class="relative max-w-4xl max-h-full w-full">
        <button onclick="closeMediaModal()" class="absolute -top-12 right-0 text-white hover:text-gray-300 text-2xl z-10 mobile-modal-close">
            <i class="fas fa-times"></i>
        </button>
        <div id="media-content" class="bg-transparent rounded-lg overflow-hidden">
            <!-- Media content will be inserted here -->
        </div>
    </div>
</div>

<!-- Edit Message Modal -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-96 mobile-edit-modal">
        <h3 class="text-lg font-semibold mb-4">Edit Message</h3>
        <textarea id="editMessageContent" class="w-full border border-gray-300 rounded-md p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 mobile-edit-textarea" rows="3"></textarea>
        <div class="flex justify-end space-x-3">
            <button onclick="closeEditModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-200 mobile-cancel-btn">
                Cancel
            </button>
            <button onclick="saveEditedMessage()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200 mobile-save-btn">
                Save Changes
            </button>
        </div>
    </div>
</div>

<script>
// Enhanced mobile functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize mobile chat
    initMobileChat();

    // Mobile chat menu
    const chatMenuBtn = document.getElementById('chat-menu-btn');
    const chatMenu = document.getElementById('chat-menu');

    if (chatMenuBtn && chatMenu) {
        chatMenuBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            chatMenu.classList.toggle('hidden');
        });

        // Close menu when clicking outside
        document.addEventListener('click', function() {
            chatMenu.classList.add('hidden');
        });
    }

    // Auto-resize textarea
    function autoResize(textarea) {
        textarea.style.height = 'auto';
        const scrollHeight = textarea.scrollHeight;
        textarea.style.height = Math.min(scrollHeight, 120) + 'px';

        // Adjust container height on mobile
        if (isMobile()) {
            adjustInputContainerHeight();
        }
    }

    // Enhanced mobile keyboard handling
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        messageInput.addEventListener('focus', function() {
            // Scroll to bottom when keyboard opens
            setTimeout(() => {
                scrollToBottom();
                // On mobile, scroll input into view
                if (isMobile()) {
                    this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 300);
        });

        messageInput.addEventListener('input', function() {
            autoResize(this);
            startTyping();
        });

        // Handle enter key for mobile (send on mobile, new line on desktop)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                if (isMobile() && !e.shiftKey) {
                    e.preventDefault();
                    sendMessageMobile();
                }
            }
        });
    }

    // Enhanced emoji picker for mobile
    function setupMobileEmojiPicker() {
        const emojiPicker = document.getElementById('emoji-picker');
        if (isMobile() && emojiPicker) {
            // Close emoji picker when scrolling (on mobile)
            const messagesContainer = document.getElementById('messages-container');
            if (messagesContainer) {
                messagesContainer.addEventListener('scroll', function() {
                    emojiPicker.classList.add('hidden');
                });
            }

            // Close emoji picker when tapping outside
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.emoji-picker-mobile') &&
                    !event.target.closest('.mobile-emoji-btn')) {
                    emojiPicker.classList.add('hidden');
                }
            });
        }
    }

    setupMobileEmojiPicker();

    // Enhanced touch reactions for mobile
    function setupTouchReactions() {
        const messageBubbles = document.querySelectorAll('.message-bubble');

        messageBubbles.forEach(bubble => {
            let touchStartTime = 0;
            let touchTimer = null;
            let touchMoved = false;

            bubble.addEventListener('touchstart', function(e) {
                touchStartTime = Date.now();
                touchMoved = false;
                touchTimer = setTimeout(() => {
                    // Long press - show reaction options
                    if (!touchMoved) {
                        showReactionOptions(e.touches[0].clientX, e.touches[0].clientY, bubble);
                    }
                }, 500);
            });

            bubble.addEventListener('touchmove', function(e) {
                touchMoved = true;
                clearTimeout(touchTimer);
            });

            bubble.addEventListener('touchend', function(e) {
                clearTimeout(touchTimer);

                // Quick tap - toggle message actions
                if (!touchMoved && Date.now() - touchStartTime < 500) {
                    const actions = this.querySelector('.message-actions');
                    if (actions) {
                        actions.classList.toggle('hidden');
                    }
                }
            });
        });
    }

    function showReactionOptions(x, y, messageBubble) {
        const messageId = messageBubble.closest('.message-group').dataset.messageId;

        // Remove existing reaction picker
        const existingPicker = document.querySelector('.mobile-reaction-picker');
        if (existingPicker) {
            existingPicker.remove();
        }

        // Create reaction picker at touch position
        const reactionPicker = document.createElement('div');
        reactionPicker.className = 'mobile-reaction-picker fixed bg-white border border-gray-300 rounded-lg shadow-lg p-2 z-50';

        // Position the picker
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;

        let left = x - 60;
        let top = y - 80;

        // Ensure picker stays within viewport
        if (left < 10) left = 10;
        if (left > viewportWidth - 130) left = viewportWidth - 130;
        if (top < 10) top = 10;
        if (top > viewportHeight - 100) top = viewportHeight - 100;

        reactionPicker.style.left = left + 'px';
        reactionPicker.style.top = top + 'px';

        const reactions = ['ğŸ‘', 'â¤ï¸', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢', 'ğŸ˜¡'];
        reactionPicker.innerHTML = `
            <div class="grid grid-cols-3 gap-1">
                ${reactions.map(emoji => `
                    <button onclick="addReactionMobile('${messageId}', '${emoji}')"
                            class="p-2 hover:bg-gray-100 rounded text-2xl transition duration-200 mobile-reaction-option">
                        ${emoji}
                    </button>
                `).join('')}
            </div>
        `;

        document.body.appendChild(reactionPicker);

        // Close on outside click
        setTimeout(() => {
            const closePicker = function(e) {
                if (!reactionPicker.contains(e.target)) {
                    reactionPicker.remove();
                    document.removeEventListener('click', closePicker);
                    document.removeEventListener('touchstart', closePicker);
                }
            };
            document.addEventListener('click', closePicker);
            document.addEventListener('touchstart', closePicker);
        }, 100);
    }

    // Initialize touch reactions
    setupTouchReactions();

    // File input for mobile
    function openFilePicker() {
        const fileInput = document.getElementById('file-input');
        if (fileInput) {
            // For mobile, ensure click works
            if (isMobile()) {
                fileInput.style.display = 'block';
                fileInput.click();
                setTimeout(() => {
                    fileInput.style.display = 'none';
                }, 100);
            } else {
                fileInput.click();
            }
        }
    }

    // Handle file selection
    document.getElementById('file-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            showFilePreview(file);
            // Auto-scroll to show preview
            setTimeout(() => {
                document.getElementById('file-preview').scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest'
                });
            }, 100);
        }
    });

    // Submit form on mobile send
    const messageForm = document.getElementById('message-form');
    if (messageForm) {
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            sendMessage();
        });
    }
});

// Enhanced mobile message sending
function sendMessage() {
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const fileInput = document.getElementById('file-input');

    if (!messageForm) return;

    const content = messageInput.value.trim();
    const hasFile = fileInput.files.length > 0;

    if (!content && !hasFile) {
        // Show error message on mobile
        if (isMobile()) {
            showMobileToast('Please enter a message or select a file');
        }
        return;
    }

    // Get CSRF token
    const csrfToken = getCSRFToken();
    if (!csrfToken) {
        console.error('CSRF token not found');
        return;
    }

    // Create form data
    const formData = new FormData();
    formData.append('content', content);
    if (hasFile) {
        formData.append('file', fileInput.files[0]);
    }
    formData.append('csrfmiddlewaretoken', csrfToken);

    // Show sending indicator on mobile
    if (isMobile()) {
        const sendBtn = document.querySelector('.mobile-send-btn');
        if (sendBtn) {
            const originalHTML = sendBtn.innerHTML;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            sendBtn.disabled = true;
        }
    }

    // Send AJAX request
    fetch(`/chat/${conversationId}/send-message/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: formData,
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Clear file input and preview
            clearFilePreview();
            document.getElementById('file-input').value = '';

            // Stop typing
            stopTyping();

            // Add message to UI
            if (data.message_id) {
                addMessageToUI(data, true);
            }

            // Show success on mobile
            if (isMobile()) {
                showMobileToast('Message sent', 'success');
            }
        } else {
            throw new Error(data.error || 'Failed to send message');
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
        if (isMobile()) {
            showMobileToast('Failed to send message: ' + error.message, 'error');
        }
    })
    .finally(() => {
        // Reset send button
        if (isMobile()) {
            const sendBtn = document.querySelector('.mobile-send-btn');
            if (sendBtn) {
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                sendBtn.disabled = false;
            }
        }
    });
}

function sendMessageMobile() {
    sendMessage();
}

// Mobile toast notification
function showMobileToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `mobile-toast fixed bottom-20 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    toast.textContent = message;
    toast.style.maxWidth = '90%';

    document.body.appendChild(toast);

    // Auto remove after 3 seconds
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// Enhanced scroll to bottom for mobile
function scrollToBottom() {
    const messagesContainer = document.getElementById('messages-container');
    if (messagesContainer) {
        // Small delay to ensure content is loaded
        setTimeout(() => {
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: 'smooth'
            });
        }, 100);
    }
}

// Adjust input container height on mobile
function adjustInputContainerHeight() {
    const inputContainer = document.querySelector('.mobile-input-container');
    const messageInput = document.getElementById('message-input');

    if (isMobile() && inputContainer && messageInput) {
        const inputHeight = messageInput.scrollHeight;
        const minHeight = 48;
        const maxHeight = 120;
        const height = Math.min(Math.max(inputHeight, minHeight), maxHeight);

        inputContainer.style.minHeight = (height + 24) + 'px'; // Add padding
    }
}

// Add reaction from mobile
function addReactionMobile(messageId, emoji) {
    addReaction(messageId, emoji);

    // Remove mobile reaction picker
    const picker = document.querySelector('.mobile-reaction-picker');
    if (picker) {
        picker.remove();
    }
}

// Initialize mobile chat
function initMobileChat() {
    // Set viewport height
    function setVH() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);

        // Adjust chat container height
        const chatContainer = document.querySelector('.mobile-chat-container');
        if (chatContainer) {
            chatContainer.style.height = 'calc(var(--vh, 1vh) * 100)';
        }
    }

    setVH();
    window.addEventListener('resize', setVH);
    window.addEventListener('orientationchange', function() {
        setTimeout(setVH, 100);
    });

    // Prevent zoom on input focus
    const inputs = document.querySelectorAll('input, textarea');
    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            if (isMobile()) {
                this.style.fontSize = '16px'; // Prevent iOS zoom
            }
        });
    });

    // Handle keyboard show/hide
    if (isMobile()) {
        let originalViewport = document.querySelector('meta[name="viewport"]').content;

        window.addEventListener('focusin', function() {
            document.querySelector('meta[name="viewport"]').content = originalViewport + ', height=' + window.innerHeight;
        });

        window.addEventListener('focusout', function() {
            document.querySelector('meta[name="viewport"]').content = originalViewport;
        });
    }
}

// Enhanced emoji picker functions
let currentEmojiCategory = 'smileys_people';

function toggleEmojiPicker() {
    const emojiPicker = document.getElementById('emoji-picker');
    const isHidden = emojiPicker.classList.contains('hidden');

    if (isHidden) {
        emojiPicker.classList.remove('hidden');
        loadEmojiCategories();
        loadEmojisByCategory('smileys_people');

        // On mobile, adjust position
        if (isMobile()) {
            emojiPicker.style.bottom = '60px';
        }
    } else {
        emojiPicker.classList.add('hidden');
    }
}

function loadEmojiCategories() {
    const categories = {
        'smileys_people': 'ğŸ˜€',
        'animals_nature': 'ğŸ¶',
        'food_drink': 'ğŸ',
        'activities': 'âš½',
        'travel_places': 'ğŸš—',
        'objects': 'ğŸ’¡',
        'symbols': 'â¤ï¸'
    };

    const categoriesContainer = document.getElementById('emoji-categories');
    let html = '';

    for (const category in categories) {
        html += `
            <button onclick="loadEmojisByCategory('${category}')"
                    class="flex-shrink-0 px-3 py-2 text-lg hover:bg-gray-100 ${currentEmojiCategory === category ? 'bg-blue-50 border-b-2 border-blue-500' : ''} mobile-category-btn">
                ${categories[category]}
            </button>
        `;
    }

    categoriesContainer.innerHTML = html;
}

function loadEmojisByCategory(category) {
    currentEmojiCategory = category;
    loadEmojiCategories();

    const emojiData = {
        'smileys_people': [
            'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š',
            'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£',
            'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—',
            'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¬', 'ğŸ™„', 'ğŸ˜¯', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜®', 'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤',
            'ğŸ¥´', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘', 'ğŸ¤ ', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ¤¡', 'ğŸ’©', 'ğŸ‘»', 'ğŸ’€', 'â˜ ï¸', 'ğŸ‘½', 'ğŸ‘¾',
            'ğŸ¤–', 'ğŸƒ', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿', 'ğŸ˜¾', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š'
        ],
        'animals_nature': [
            'ğŸµ', 'ğŸ’', 'ğŸ¦', 'ğŸ¦§', 'ğŸ¶', 'ğŸ•', 'ğŸ¦®', 'ğŸ•â€ğŸ¦º', 'ğŸ©', 'ğŸº', 'ğŸ¦Š', 'ğŸ¦', 'ğŸ±', 'ğŸˆ', 'ğŸˆâ€â¬›', 'ğŸ¦', 'ğŸ¯', 'ğŸ…', 'ğŸ†', 'ğŸ´',
            'ğŸ', 'ğŸ¦„', 'ğŸ¦“', 'ğŸ¦Œ', 'ğŸ®', 'ğŸ‚', 'ğŸƒ', 'ğŸ„', 'ğŸ·', 'ğŸ–', 'ğŸ—', 'ğŸ½', 'ğŸ', 'ğŸ‘', 'ğŸ', 'ğŸª', 'ğŸ«', 'ğŸ¦™', 'ğŸ¦’', 'ğŸ˜',
            'ğŸ¦', 'ğŸ¦›', 'ğŸ­', 'ğŸ', 'ğŸ€', 'ğŸ¹', 'ğŸ°', 'ğŸ‡', 'ğŸ¿ï¸', 'ğŸ¦”', 'ğŸ¦‡', 'ğŸ»', 'ğŸ»â€â„ï¸', 'ğŸ¨', 'ğŸ¼', 'ğŸ¦¥', 'ğŸ¦¦', 'ğŸ¦¨', 'ğŸ¦˜', 'ğŸ¦¡',
            'ğŸ¾', 'ğŸ¦ƒ', 'ğŸ”', 'ğŸ“', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ§', 'ğŸ•Šï¸', 'ğŸ¦…', 'ğŸ¦†', 'ğŸ¦¢', 'ğŸ¦‰', 'ğŸ¦¤', 'ğŸª¶', 'ğŸ¦©', 'ğŸ¦š', 'ğŸ¦œ', 'ğŸ¸',
            'ğŸŠ', 'ğŸ¢', 'ğŸ¦', 'ğŸ', 'ğŸ²', 'ğŸ‰', 'ğŸ¦•', 'ğŸ¦–', 'ğŸ³', 'ğŸ‹', 'ğŸ¬', 'ğŸ¦­', 'ğŸŸ', 'ğŸ ', 'ğŸ¡', 'ğŸ¦ˆ', 'ğŸ™', 'ğŸš', 'ğŸŒ', 'ğŸ¦‹',
            'ğŸ›', 'ğŸœ', 'ğŸ', 'ğŸª²', 'ğŸ', 'ğŸ¦—', 'ğŸª³', 'ğŸ•·ï¸', 'ğŸ•¸ï¸', 'ğŸ¦‚', 'ğŸ¦Ÿ', 'ğŸª°', 'ğŸª±', 'ğŸ¦ ', 'ğŸ’', 'ğŸŒ¸', 'ğŸ’®', 'ğŸµï¸', 'ğŸŒ¹', 'ğŸ¥€',
            'ğŸŒº', 'ğŸŒ»', 'ğŸŒ¼', 'ğŸŒ·', 'ğŸŒ±', 'ğŸª´', 'ğŸŒ²', 'ğŸŒ³', 'ğŸŒ´', 'ğŸŒµ', 'ğŸŒ¾', 'ğŸŒ¿', 'â˜˜ï¸', 'ğŸ€', 'ğŸ', 'ğŸ‚', 'ğŸƒ'
        ],
        'food_drink': [
            'ğŸ‡', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ', 'ğŸ¥­', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ‘', 'ğŸ’', 'ğŸ“', 'ğŸ«', 'ğŸ¥', 'ğŸ…', 'ğŸ«’', 'ğŸ¥¥', 'ğŸ¥‘',
            'ğŸ†', 'ğŸ¥”', 'ğŸ¥•', 'ğŸŒ½', 'ğŸŒ¶ï¸', 'ğŸ«‘', 'ğŸ¥’', 'ğŸ¥¬', 'ğŸ¥¦', 'ğŸ§„', 'ğŸ§…', 'ğŸ„', 'ğŸ¥œ', 'ğŸŒ°', 'ğŸ', 'ğŸ¥', 'ğŸ¥–', 'ğŸ«“', 'ğŸ¥¨', 'ğŸ¥¯',
            'ğŸ¥', 'ğŸ§‡', 'ğŸ§€', 'ğŸ–', 'ğŸ—', 'ğŸ¥©', 'ğŸ¥“', 'ğŸ”', 'ğŸŸ', 'ğŸ•', 'ğŸŒ­', 'ğŸ¥ª', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸ«”', 'ğŸ¥™', 'ğŸ§†', 'ğŸ¥š', 'ğŸ³', 'ğŸ¥˜',
            'ğŸ²', 'ğŸ«•', 'ğŸ¥£', 'ğŸ¥—', 'ğŸ¿', 'ğŸ§ˆ', 'ğŸ§‚', 'ğŸ¥«', 'ğŸ±', 'ğŸ˜', 'ğŸ™', 'ğŸš', 'ğŸ›', 'ğŸœ', 'ğŸ', 'ğŸ ', 'ğŸ¢', 'ğŸ£', 'ğŸ¤', 'ğŸ¥',
            'ğŸ¥®', 'ğŸ¡', 'ğŸ¥Ÿ', 'ğŸ¥ ', 'ğŸ¥¡', 'ğŸ¦€', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦‘', 'ğŸ¦ª', 'ğŸ¦', 'ğŸ§', 'ğŸ¨', 'ğŸ©', 'ğŸª', 'ğŸ‚', 'ğŸ°', 'ğŸ§', 'ğŸ¥§', 'ğŸ«',
            'ğŸ¬', 'ğŸ­', 'ğŸ®', 'ğŸ¯', 'ğŸ¼', 'ğŸ¥›', 'â˜•', 'ğŸ«–', 'ğŸµ', 'ğŸ¶', 'ğŸ¾', 'ğŸ·', 'ğŸ¸', 'ğŸ¹', 'ğŸº', 'ğŸ»', 'ğŸ¥‚', 'ğŸ¥ƒ', 'ğŸ¥¤', 'ğŸ§‹',
            'ğŸ§ƒ', 'ğŸ§‰', 'ğŸ§Š', 'ğŸ¥¢', 'ğŸ½ï¸', 'ğŸ´', 'ğŸ¥„', 'ğŸ”ª', 'ğŸº'
        ],
        'activities': [
            'âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ±', 'ğŸª€', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ', 'ğŸªƒ', 'ğŸ¥…', 'â›³',
            'ğŸª', 'ğŸ¹', 'ğŸ£', 'ğŸ¤¿', 'ğŸ¥Š', 'ğŸ¥‹', 'ğŸ½', 'ğŸ›¹', 'ğŸ›¼', 'ğŸ›·', 'â›¸ï¸', 'ğŸ¥Œ', 'ğŸ¿', 'â›·ï¸', 'ğŸ‚', 'ğŸª‚', 'ğŸ‹ï¸', 'ğŸ¤¼', 'ğŸ¤¸', 'â›¹ï¸',
            'ğŸ¤¾', 'ğŸŒï¸', 'ğŸ‡', 'ğŸ§˜', 'ğŸ„', 'ğŸŠ', 'ğŸ¤½', 'ğŸš£', 'ğŸ§—', 'ğŸšµ', 'ğŸ¯', 'ğŸ®', 'ğŸ•¹ï¸', 'ğŸ²', 'ğŸ§©', 'ğŸ§¸', 'â™ ï¸', 'â™¥ï¸', 'â™¦ï¸', 'â™£ï¸',
            'â™Ÿï¸', 'ğŸƒ', 'ğŸ€„', 'ğŸ´', 'ğŸ­', 'ğŸ–¼ï¸', 'ğŸ¨', 'ğŸ§µ', 'ğŸª¡', 'ğŸ§¶', 'ğŸª¢', 'ğŸ‘“', 'ğŸ•¶ï¸', 'ğŸ¥½', 'ğŸ¥¼', 'ğŸ¦º', 'ğŸ‘”', 'ğŸ‘•', 'ğŸ‘–', 'ğŸ§£',
            'ğŸ§¤', 'ğŸ§¥', 'ğŸ§¦', 'ğŸ‘—', 'ğŸ‘˜', 'ğŸ¥»', 'ğŸ©±', 'ğŸ©²', 'ğŸ©³', 'ğŸ‘™', 'ğŸ‘š', 'ğŸ‘›', 'ğŸ‘œ', 'ğŸ‘', 'ğŸ’', 'ğŸ©´', 'ğŸ‘', 'ğŸ‘Ÿ', 'ğŸ¥¾', 'ğŸ¥¿',
            'ğŸ‘ ', 'ğŸ‘¡', 'ğŸ©°', 'ğŸ‘¢', 'ğŸ‘‘', 'ğŸ‘’', 'ğŸ©', 'ğŸ“', 'ğŸ§¢', 'ğŸª–', 'ğŸ’„', 'ğŸ’', 'ğŸ’¼'
        ],
        'travel_places': [
            'ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸšŒ', 'ğŸš', 'ğŸï¸', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš', 'ğŸ›»', 'ğŸšš', 'ğŸš›', 'ğŸšœ', 'ğŸï¸', 'ğŸ›µ', 'ğŸš²', 'ğŸ›´', 'ğŸ›¹', 'ğŸ›¼',
            'ğŸš', 'ğŸ›£ï¸', 'ğŸ›¤ï¸', 'â›½', 'ğŸš¨', 'ğŸš¥', 'ğŸš¦', 'ğŸ›‘', 'ğŸš§', 'âš“', 'â›µ', 'ğŸ›¶', 'ğŸš¤', 'ğŸ›³ï¸', 'â›´ï¸', 'ğŸ›¥ï¸', 'ğŸš¢', 'âœˆï¸', 'ğŸ›©ï¸', 'ğŸ›«',
            'ğŸ›¬', 'ğŸª‚', 'ğŸ’º', 'ğŸš', 'ğŸšŸ', 'ğŸš ', 'ğŸš¡', 'ğŸ›°ï¸', 'ğŸš€', 'ğŸ›¸', 'ğŸ›ï¸', 'ğŸ§³', 'âŒ›', 'â³', 'âŒš', 'â°', 'â±ï¸', 'â²ï¸', 'ğŸ•°ï¸', 'ğŸŒ¡ï¸',
            'ğŸ—ºï¸', 'ğŸ§­', 'ğŸ”ï¸', 'â›°ï¸', 'ğŸŒ‹', 'ğŸ—»', 'ğŸ•ï¸', 'ğŸ–ï¸', 'ğŸœï¸', 'ğŸï¸', 'ğŸï¸', 'ğŸŸï¸', 'ğŸ›ï¸', 'ğŸ—ï¸', 'ğŸ§±', 'ğŸª¨', 'ğŸªµ', 'ğŸ›–', 'ğŸ˜ï¸',
            'ğŸšï¸', 'ğŸ ', 'ğŸ¡', 'ğŸ¢', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ¨', 'ğŸ©', 'ğŸª', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ¯', 'ğŸ°', 'ğŸ’’', 'ğŸ—¼', 'ğŸ—½', 'â›ª',
            'ğŸ•Œ', 'ğŸ›•', 'ğŸ•', 'â›©ï¸', 'ğŸ•‹', 'âš›ï¸', 'ğŸ›', 'â˜®ï¸', 'âœï¸', 'â˜ªï¸', 'ğŸ•‰ï¸', 'â˜¸ï¸', 'âœ¡ï¸', 'ğŸ”¯', 'ğŸ•', 'â˜¯ï¸', 'â˜¦ï¸', 'ğŸ›'
        ],
        'objects': [
            'âŒš', 'ğŸ“±', 'ğŸ“²', 'ğŸ’»', 'âŒ¨ï¸', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'ğŸ–±ï¸', 'ğŸ–²ï¸', 'ğŸ•¹ï¸', 'ğŸ—œï¸', 'ğŸ’½', 'ğŸ’¾', 'ğŸ’¿', 'ğŸ“€', 'ğŸ“¼', 'ğŸ“·', 'ğŸ“¸', 'ğŸ“¹', 'ğŸ¥',
            'ğŸ“½ï¸', 'ğŸï¸', 'ğŸ“', 'â˜ï¸', 'ğŸ“Ÿ', 'ğŸ“ ', 'ğŸ“º', 'ğŸ“»', 'ğŸ™ï¸', 'ğŸšï¸', 'ğŸ›ï¸', 'ğŸ§­', 'â±ï¸', 'â²ï¸', 'â°', 'ğŸ•°ï¸', 'âŒ›', 'â³', 'ğŸ“¡', 'ğŸ”‹',
            'ğŸ”Œ', 'ğŸ’¡', 'ğŸ”¦', 'ğŸ•¯ï¸', 'ğŸª”', 'ğŸ§¯', 'ğŸ›¢ï¸', 'ğŸ’¸', 'ğŸ’µ', 'ğŸ’´', 'ğŸ’¶', 'ğŸ’·', 'ğŸ’°', 'ğŸ’³', 'ğŸ’', 'âš–ï¸', 'ğŸ§°', 'ğŸ”§', 'ğŸ”¨', 'âš’ï¸',
            'ğŸ› ï¸', 'â›ï¸', 'ğŸ”©', 'âš™ï¸', 'ğŸ§±', 'â›“ï¸', 'ğŸ§²', 'ğŸ”«', 'ğŸ’£', 'ğŸ§¨', 'ğŸª“', 'ğŸ”ª', 'ğŸ—¡ï¸', 'âš”ï¸', 'ğŸ›¡ï¸', 'ğŸš¬', 'âš°ï¸', 'âš±ï¸', 'ğŸº', 'ğŸ”®',
            'ğŸ“¿', 'ğŸ§¿', 'ğŸ’ˆ', 'âš—ï¸', 'ğŸ”­', 'ğŸ”¬', 'ğŸ•³ï¸', 'ğŸ©¹', 'ğŸ©º', 'ğŸ’Š', 'ğŸ’‰', 'ğŸ©¸', 'ğŸ§¬', 'ğŸ¦ ', 'ğŸ§«', 'ğŸ§ª', 'ğŸŒ¡ï¸', 'ğŸ§¹', 'ğŸ§º', 'ğŸ§»',
            'ğŸš½', 'ğŸš°', 'ğŸš¿', 'ğŸ›', 'ğŸ›€', 'ğŸ§¼', 'ğŸª’', 'ğŸ§½', 'ğŸ§´', 'ğŸ›ï¸', 'ğŸ”‘', 'ğŸ—ï¸', 'ğŸšª', 'ğŸª‘', 'ğŸ›‹ï¸', 'ğŸ›ï¸', 'ğŸ›Œ', 'ğŸ§¸', 'ğŸ–¼ï¸', 'ğŸ›ï¸',
            'ğŸ›’', 'ğŸ', 'ğŸˆ', 'ğŸ', 'ğŸ€', 'ğŸŠ', 'ğŸ‰', 'ğŸ', 'ğŸ®', 'ğŸ', 'âœ‰ï¸', 'ğŸ“©', 'ğŸ“¨', 'ğŸ“§', 'ğŸ’Œ', 'ğŸ“¥', 'ğŸ“¤', 'ğŸ“¦', 'ğŸ·ï¸', 'ğŸ“ª',
            'ğŸ“«', 'ğŸ“¬', 'ğŸ“­', 'ğŸ“®', 'ğŸ“¯', 'ğŸ“œ', 'ğŸ“ƒ', 'ğŸ“„', 'ğŸ“‘', 'ğŸ§¾', 'ğŸ“Š', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ—’ï¸', 'ğŸ—“ï¸', 'ğŸ“†', 'ğŸ“…', 'ğŸ—‘ï¸', 'ğŸ“‡', 'ğŸ—ƒï¸',
            'ğŸ—³ï¸', 'ğŸ—„ï¸', 'ğŸ“‹', 'ğŸ“', 'ğŸ“‚', 'ğŸ—‚ï¸', 'ğŸ—ï¸', 'ğŸ“°', 'ğŸ““', 'ğŸ“”', 'ğŸ“’', 'ğŸ“•', 'ğŸ“—', 'ğŸ“˜', 'ğŸ“™', 'ğŸ“š', 'ğŸ“–', 'ğŸ”–', 'ğŸ§·', 'ğŸ”—',
            'ğŸ“', 'ğŸ–‡ï¸', 'ğŸ“', 'ğŸ“', 'ğŸ§®', 'ğŸ“Œ', 'ğŸ“', 'âœ‚ï¸', 'ğŸ–Šï¸', 'ğŸ–‹ï¸', 'âœ’ï¸', 'ğŸ–Œï¸', 'ğŸ–ï¸', 'ğŸ“', 'âœï¸', 'ğŸ”', 'ğŸ”', 'ğŸ”', 'ğŸ”', 'ğŸ”’',
            'ğŸ”“'
        ],
        'symbols': [
            'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'â˜®ï¸',
            'âœï¸', 'â˜ªï¸', 'ğŸ•‰ï¸', 'â˜¸ï¸', 'âœ¡ï¸', 'ğŸ”¯', 'ğŸ•', 'â˜¯ï¸', 'â˜¦ï¸', 'ğŸ›', 'â›', 'â™ˆ', 'â™‰', 'â™Š', 'â™‹', 'â™Œ', 'â™', 'â™', 'â™', 'â™', 'â™‘',
            'â™’', 'â™“', 'ğŸ†”', 'âš›ï¸', 'ğŸ‰‘', 'â˜¢ï¸', 'â˜£ï¸', 'ğŸ“´', 'ğŸ“³', 'ğŸˆ¶', 'ğŸˆš', 'ğŸˆ¸', 'ğŸˆº', 'ğŸˆ·ï¸', 'âœ´ï¸', 'ğŸ†š', 'ğŸ’®', 'ğŸ‰', 'ãŠ™ï¸', 'ãŠ—ï¸',
            'ğŸˆ´', 'ğŸˆµ', 'ğŸˆ¹', 'ğŸˆ²', 'ğŸ…°ï¸', 'ğŸ…±ï¸', 'ğŸ†', 'ğŸ†‘', 'ğŸ…¾ï¸', 'ğŸ†˜', 'âŒ', 'â­•', 'ğŸ›‘', 'â›”', 'ğŸ“›', 'ğŸš«', 'ğŸ’¯', 'ğŸ’¢', 'â™¨ï¸', 'ğŸš·',
            'ğŸš¯', 'ğŸš³', 'ğŸš±', 'ğŸ”', 'ğŸ“µ', 'ğŸš­', 'â—', 'â•', 'â“', 'â”', 'â€¼ï¸', 'â‰ï¸', 'ğŸ”…', 'ğŸ”†', 'ã€½ï¸', 'âš ï¸', 'ğŸš¸', 'ğŸ”±', 'âšœï¸', 'ğŸ”°',
            'â™»ï¸', 'âœ…', 'ğŸˆ¯', 'ğŸ’¹', 'â‡ï¸', 'âœ³ï¸', 'â', 'ğŸŒ', 'ğŸ’ ', 'â“‚ï¸', 'ğŸŒ€', 'ğŸ’¤', 'ğŸ§', 'ğŸš¾', 'â™¿', 'ğŸ…¿ï¸', 'ğŸ›—', 'ğŸˆ³', 'ğŸˆ‚ï¸', 'ğŸ›‚',
            'ğŸ›ƒ', 'ğŸ›„', 'ğŸ›…', 'ğŸš¹', 'ğŸšº', 'ğŸš¼', 'ğŸš»', 'ğŸš®', 'ğŸ¦', 'ğŸ“¶', 'ğŸˆ', 'ğŸ”£', 'â„¹ï¸', 'ğŸ”¤', 'ğŸ”¡', 'ğŸ” ', 'ğŸ†–', 'ğŸ†—', 'ğŸ†™', 'ğŸ†’',
            'ğŸ†•', 'ğŸ†“', '0ï¸âƒ£', '1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ğŸ”Ÿ', 'ğŸ”¢', '#ï¸âƒ£', '*ï¸âƒ£', 'âï¸', 'â–¶ï¸', 'â¸ï¸', 'â¯ï¸',
            'â¹ï¸', 'âºï¸', 'â­ï¸', 'â®ï¸', 'â©', 'âª', 'â«', 'â¬', 'â—€ï¸', 'ğŸ”¼', 'ğŸ”½', 'â¡ï¸', 'â¬…ï¸', 'â¬†ï¸', 'â¬‡ï¸', 'â†—ï¸', 'â†˜ï¸', 'â†™ï¸', 'â†–ï¸', 'â†•ï¸',
            'â†”ï¸', 'â†ªï¸', 'â†©ï¸', 'â¤´ï¸', 'â¤µï¸', 'ğŸ”€', 'ğŸ”', 'ğŸ”‚', 'ğŸ”„', 'ğŸ”ƒ', 'ğŸµ', 'ğŸ¶', 'â•', 'â–', 'â—', 'â™¾ï¸', 'ğŸ’²', 'ğŸ’±', 'â„¢ï¸', 'Â©ï¸', 'Â®ï¸',
            'ã€°ï¸', 'â°', 'â¿', 'ğŸ”š', 'ğŸ”™', 'ğŸ”›', 'ğŸ”', 'ğŸ”œ'
        ]
    };

    const emojiGrid = document.getElementById('emoji-grid');
    const emojis = emojiData[category] || [];

    // Adjust columns for mobile
    const cols = isMobile() ? 6 : 8;
    let html = `<div class="grid grid-cols-${cols} gap-${isMobile() ? '1' : '2'}">`;
    emojis.forEach(emojiChar => {
        html += `
            <button onclick="insertEmoji('${emojiChar}')"
                    class="text-xl p-${isMobile() ? '1' : '2'} hover:bg-gray-100 rounded-lg transition duration-200 mobile-emoji-option">
                ${emojiChar}
            </button>
        `;
    });
    html += '</div>';

    emojiGrid.innerHTML = html;
}

function insertEmoji(emojiChar) {
    const messageInput = document.getElementById('message-input');
    if (!messageInput) return;

    const cursorPosition = messageInput.selectionStart;
    const currentValue = messageInput.value;

    messageInput.value = currentValue.substring(0, cursorPosition) + emojiChar + currentValue.substring(cursorPosition);
    messageInput.focus();

    // Move cursor after inserted emoji
    setTimeout(() => {
        messageInput.selectionStart = cursorPosition + emojiChar.length;
        messageInput.selectionEnd = cursorPosition + emojiChar.length;
    }, 10);

    // Trigger input event for typing indicator and auto-resize
    messageInput.dispatchEvent(new Event('input'));

    // Close emoji picker on mobile
    if (isMobile()) {
        document.getElementById('emoji-picker').classList.add('hidden');
    }
}

// Close emoji picker when clicking outside
document.addEventListener('click', function(event) {
    const emojiPicker = document.getElementById('emoji-picker');
    const emojiButton = event.target.closest('button[onclick*="toggleEmojiPicker"], .mobile-emoji-btn');

    if (emojiPicker && !emojiPicker.contains(event.target) && !emojiButton) {
        emojiPicker.classList.add('hidden');
    }
});

// Search emojis
document.getElementById('emoji-search').addEventListener('input', function() {
    const query = this.value.toLowerCase();
    if (query.length === 0) {
        loadEmojisByCategory(currentEmojiCategory);
        return;
    }

    // Simple search implementation
    const allEmojis = Object.values({
        'smileys_people': ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡'],
        'animals_nature': ['ğŸµ', 'ğŸ’', 'ğŸ¦', 'ğŸ¦§', 'ğŸ¶', 'ğŸ•', 'ğŸ¦®', 'ğŸ•â€ğŸ¦º', 'ğŸ©', 'ğŸº'],
        'food_drink': ['ğŸ‡', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ', 'ğŸ¥­', 'ğŸ', 'ğŸ'],
        'activities': ['âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ±'],
        'travel_places': ['ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸšŒ', 'ğŸš', 'ğŸï¸', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš'],
        'objects': ['âŒš', 'ğŸ“±', 'ğŸ“²', 'ğŸ’»', 'âŒ¨ï¸', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'ğŸ–±ï¸', 'ğŸ–²ï¸', 'ğŸ•¹ï¸'],
        'symbols': ['â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”']
    }).flat();

    const results = allEmojis.filter(emoji => {
        return emoji.includes(query) || query.length === 0;
    }).slice(0, 48);

    const emojiGrid = document.getElementById('emoji-grid');

    if (results.length === 0) {
        emojiGrid.innerHTML = '<p class="text-center text-gray-500 py-4">No emojis found</p>';
        return;
    }

    const cols = isMobile() ? 6 : 8;
    let html = `<div class="grid grid-cols-${cols} gap-${isMobile() ? '1' : '2'}">`;
    results.forEach(emojiChar => {
        html += `
            <button onclick="insertEmoji('${emojiChar}')"
                    class="text-xl p-${isMobile() ? '1' : '2'} hover:bg-gray-100 rounded-lg transition duration-200">
                ${emojiChar}
            </button>
        `;
    });
    html += '</div>';

    emojiGrid.innerHTML = html;
});

// Media Modal Functions
function openMediaModal(url, type) {
    const modal = document.getElementById('mediaModal');
    const content = document.getElementById('media-content');

    if (type === 'image') {
        content.innerHTML = `<img src="${url}" alt="Shared image" class="w-full h-auto max-h-screen object-contain mobile-full-image">`;
    } else if (type === 'video') {
        content.innerHTML = `
            <video controls autoplay class="w-full h-auto max-h-screen mobile-full-video">
                <source src="${url}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        `;
    }

    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Prevent scrolling on mobile
    if (isMobile()) {
        document.querySelector('html').style.overflow = 'hidden';
    }
}

function closeMediaModal() {
    const modal = document.getElementById('mediaModal');
    const content = document.getElementById('media-content');

    // Stop video playback
    const video = content.querySelector('video');
    if (video) {
        video.pause();
        video.currentTime = 0;
    }

    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';

    // Restore scrolling on mobile
    if (isMobile()) {
        document.querySelector('html').style.overflow = 'auto';
    }

    content.innerHTML = '';
}

// Close modal when clicking on background
document.getElementById('mediaModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeMediaModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const mediaModal = document.getElementById('mediaModal');
        if (!mediaModal.classList.contains('hidden')) {
            closeMediaModal();
        }

        const editModal = document.getElementById('editModal');
        if (!editModal.classList.contains('hidden')) {
            closeEditModal();
        }
    }
});

// Message Action Functions
let currentEditingMessageId = null;

function editMessage(messageId) {
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    const contentElement = messageElement.querySelector('.message-content');

    document.getElementById('editMessageContent').value = contentElement.textContent;
    document.getElementById('editModal').classList.remove('hidden');
    currentEditingMessageId = messageId;

    // Focus on textarea
    setTimeout(() => {
        document.getElementById('editMessageContent').focus();
    }, 100);
}

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
    currentEditingMessageId = null;
}

function saveEditedMessage() {
    if (!currentEditingMessageId) return;

    const newContent = document.getElementById('editMessageContent').value.trim();
    if (!newContent) return;

    // Show loading on mobile
    if (isMobile()) {
        const saveBtn = document.querySelector('.mobile-save-btn');
        if (saveBtn) {
            const originalHTML = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            saveBtn.disabled = true;
        }
    }

    fetch(`/chat/message/${currentEditingMessageId}/edit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ content: newContent })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const messageElement = document.querySelector(`[data-message-id="${currentEditingMessageId}"]`);
            const contentElement = messageElement.querySelector('.message-content');
            contentElement.textContent = data.new_content;

            // Add edited indicator if not exists
            const metaElement = messageElement.querySelector('.flex.items-center.space-x-2');
            if (!metaElement.querySelector('.edited-indicator')) {
                const editedSpan = document.createElement('span');
                editedSpan.className = 'text-xs opacity-70 edited-indicator';
                editedSpan.textContent = 'edited';
                metaElement.appendChild(editedSpan);
            }

            closeEditModal();

            if (isMobile()) {
                showMobileToast('Message edited', 'success');
            }
        } else {
            throw new Error(data.error || 'Failed to edit message');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (isMobile()) {
            showMobileToast('Error editing message', 'error');
        } else {
            alert('Error: ' + error.message);
        }
    })
    .finally(() => {
        // Reset button
        if (isMobile()) {
            const saveBtn = document.querySelector('.mobile-save-btn');
            if (saveBtn) {
                saveBtn.innerHTML = 'Save Changes';
                saveBtn.disabled = false;
            }
        }
    });
}

function unsendMessage(messageId) {
    if (!confirm('Are you sure you want to unsend this message? This cannot be undone.')) {
        return;
    }

    fetch(`/chat/message/${messageId}/unsend/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            const contentElement = messageElement.querySelector('.message-content');
            if (contentElement) {
                contentElement.innerHTML = '<p class="text-sm italic opacity-70">This message was unsent</p>';
            }

            // Hide message actions
            const actionsElement = messageElement.querySelector('.message-actions');
            if (actionsElement) {
                actionsElement.remove();
            }

            // Hide reactions
            const reactionsElement = messageElement.querySelector('.message-reactions');
            if (reactionsElement) {
                reactionsElement.innerHTML = '';
            }

            if (isMobile()) {
                showMobileToast('Message unsent', 'success');
            }
        } else {
            throw new Error(data.error || 'Failed to unsend message');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (isMobile()) {
            showMobileToast('Error unsending message', 'error');
        } else {
            alert('Error: ' + error.message);
        }
    });
}

function toggleReactions(messageId) {
    const reactionsPicker = document.getElementById(`reactions-${messageId}`);
    if (!reactionsPicker) return;

    reactionsPicker.classList.toggle('hidden');

    // Close other reaction pickers
    document.querySelectorAll('.reaction-picker').forEach(picker => {
        if (picker.id !== `reactions-${messageId}`) {
            picker.classList.add('hidden');
        }
    });
}

function addReaction(messageId, emoji) {
    fetch(`/chat/message/${messageId}/react/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ reaction: emoji })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateReactionsDisplay(messageId, data.reactions);
            toggleReactions(messageId); // Close picker
        } else {
            throw new Error(data.error || 'Failed to add reaction');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (isMobile()) {
            showMobileToast('Error adding reaction', 'error');
        }
    });
}

function updateReactionsDisplay(messageId, reactions) {
    const reactionsContainer = document.querySelector(`[data-message-id="${messageId}"] .message-reactions`);
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    const isOwn = messageElement.classList.contains('justify-end');

    if (!reactionsContainer) return;

    if (Object.keys(reactions).length === 0) {
        reactionsContainer.innerHTML = '';
        return;
    }

    let html = '';
    for (const [emoji, count] of Object.entries(reactions)) {
        html += `<span class="text-xs ${isOwn ? 'bg-white bg-opacity-20' : 'bg-gray-100'} rounded-full px-1 mobile-reaction-badge">${emoji} ${count}</span>`;
    }

    reactionsContainer.innerHTML = html;
}

// Close reaction pickers when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.reaction-picker') && !event.target.closest('[onclick*="toggleReactions"]')) {
        document.querySelectorAll('.reaction-picker').forEach(picker => {
            picker.classList.add('hidden');
        });
    }
});

// File upload functionality
function showFilePreview(file) {
    const filePreview = document.getElementById('file-preview');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');

    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    filePreview.classList.remove('hidden');
}

function clearFilePreview() {
    document.getElementById('file-input').value = '';
    document.getElementById('file-preview').classList.add('hidden');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Real-time chat functionality
let typingTimer;
const TYPING_TIMEOUT = 3000;
const conversationId = '{{ conversation.id }}';

function checkForUpdates() {
    // Check for new messages
    fetch(`/chat/${conversationId}/new-messages/`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.has_new_messages) {
                data.new_messages.forEach(message => {
                    // Check if message already exists
                    if (!document.querySelector(`[data-message-id="${message.id}"]`)) {
                        addReceivedMessage(message);
                    }
                });
            }
        })
        .catch(error => console.error('Error checking for updates:', error));

    // Check typing status
    fetch(`/chat/${conversationId}/typing-status/`)
        .then(response => response.json())
        .then(data => {
            if (data.is_typing && data.typing_users.length > 0) {
                showTypingIndicator(data.typing_users);
            } else {
                hideTypingIndicator();
            }
        })
        .catch(error => console.error('Error checking typing status:', error));
}

function addReceivedMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-group flex justify-start message-fade-in';
    messageDiv.id = `message-${message.id}`;
    messageDiv.setAttribute('data-message-id', message.id);

    messageDiv.innerHTML = createMessageHTML(message, false);
    document.getElementById('messages-list').appendChild(messageDiv);
    scrollToBottom();

    // Remove empty state
    const emptyState = document.getElementById('empty-state');
    if (emptyState) {
        emptyState.remove();
    }

    // Play notification sound on mobile if not focused
    if (isMobile() && document.visibilityState !== 'visible') {
        playNotificationSound();
    }
}

function playNotificationSound() {
    // Simple notification sound using Web Audio API
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800;
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
    } catch (e) {
        console.log('Audio not supported');
    }
}

function createMessageHTML(message, isOwn) {
    const isGroup = {% if is_group %}true{% else %}false{% endif %};
    const isUnsent = message.is_unsent;

    let messageHTML = `
        <div class="message-bubble relative group max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${isOwn ? 'bg-blue-600 text-white' : 'bg-white border border-gray-200 text-gray-900'}">
    `;

    // Message header for group
    if (isGroup && !isOwn && !isUnsent) {
        messageHTML += `<p class="text-xs font-medium ${isOwn ? 'text-blue-100' : 'text-blue-600'} mb-1">${message.sender}</p>`;
    }

    // Message content
    if (isUnsent) {
        messageHTML += `<p class="text-sm italic opacity-70">This message was unsent</p>`;
    } else {
        if (message.message_type === 'text') {
            messageHTML += `<p class="text-sm message-content">${message.content}</p>`;
        } else if (message.message_type === 'emoji') {
            messageHTML += `
                <div class="emoji-message text-4xl text-center py-2">
                    ${message.content}
                </div>
            `;
        } else if (message.message_type === 'image') {
            messageHTML += `
                <div class="mb-2">
                    <img src="${message.file_url}" alt="Shared image"
                         class="max-w-full h-auto rounded-lg cursor-pointer mobile-media"
                         onclick="openMediaModal('${message.file_url}', 'image')">
                </div>
            `;
            if (message.content) {
                messageHTML += `<p class="text-sm message-content mt-2">${message.content}</p>`;
            }
        } else if (message.message_type === 'video') {
            messageHTML += `
                <div class="mb-2">
                    <video controls class="max-w-full h-auto rounded-lg cursor-pointer mobile-media"
                           onclick="openMediaModal('${message.file_url}', 'video')">
                        <source src="${message.file_url}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            `;
            if (message.content) {
                messageHTML += `<p class="text-sm message-content mt-2">${message.content}</p>`;
            }
        } else if (message.message_type === 'audio') {
            messageHTML += `
                <div class="mb-2">
                    <audio controls class="w-full mobile-audio">
                        <source src="${message.file_url}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                </div>
            `;
            if (message.content) {
                messageHTML += `<p class="text-sm message-content mt-2">${message.content}</p>`;
            }
        } else if (message.message_type === 'file') {
            messageHTML += `
                <div class="mb-2 p-3 ${isOwn ? 'bg-white bg-opacity-20' : 'bg-gray-100'} rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0 w-10 h-10 ${isOwn ? 'bg-white bg-opacity-30' : 'bg-blue-100'} rounded-lg flex items-center justify-center">
                            <i class="fas fa-file ${isOwn ? 'text-white' : 'text-blue-600'}"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium ${isOwn ? 'text-white' : 'text-gray-900'} truncate">
                                ${message.file_name || 'File'}
                            </p>
                            <p class="text-xs ${isOwn ? 'text-blue-100' : 'text-gray-500'}">
                                ${message.file_size}
                            </p>
                        </div>
                        <a href="${message.file_url}" download
                           class="flex-shrink-0 p-2 ${isOwn ? 'bg-white bg-opacity-20 hover:bg-opacity-30' : 'bg-blue-100 hover:bg-blue-200'} rounded-lg transition duration-200"
                           title="Download file">
                            <i class="fas fa-download ${isOwn ? 'text-white' : 'text-blue-600'} text-sm"></i>
                        </a>
                    </div>
                </div>
            `;
            if (message.content) {
                messageHTML += `<p class="text-sm message-content mt-2">${message.content}</p>`;
            }
        }
    }

    // Message meta
    messageHTML += `
        <div class="flex items-center justify-between mt-1">
            <div class="flex items-center space-x-2">
                <span class="text-xs opacity-70 ${isOwn ? 'text-blue-100' : 'text-gray-500'}">${message.timestamp}</span>
    `;

    if (message.is_edited && !isUnsent) {
        messageHTML += `<span class="text-xs opacity-70 ${isOwn ? 'text-blue-100' : 'text-gray-500'}">edited</span>`;
    }

    if (isOwn && !isUnsent) {
        if (message.is_read) {
            messageHTML += `<i class="fas fa-check-double text-xs opacity-70 ${isOwn ? 'text-blue-100' : 'text-gray-500'}"></i>`;
        } else {
            messageHTML += `<i class="fas fa-check text-xs opacity-70 ${isOwn ? 'text-blue-100' : 'text-gray-500'}"></i>`;
        }
    }

    messageHTML += `</div>`;

    // Reactions
    if (!isUnsent && message.reactions && Object.keys(message.reactions).length > 0) {
        messageHTML += `<div class="message-reactions flex space-x-1">`;
        for (const [emoji, count] of Object.entries(message.reactions)) {
            messageHTML += `<span class="text-xs ${isOwn ? 'bg-white bg-opacity-20' : 'bg-gray-100'} rounded-full px-1 mobile-reaction-badge">${emoji} ${count}</span>`;
        }
        messageHTML += `</div>`;
    }

    messageHTML += `</div>`;

    // Message actions
    if (isOwn && !isUnsent) {
        messageHTML += `
            <div class="message-actions absolute -top-8 right-0 bg-white border border-gray-300 rounded-lg shadow-lg p-1 hidden group-hover:flex space-x-1">
        `;

        // Edit button only for text messages
        if (message.message_type === 'text') {
            messageHTML += `
                <button onclick="editMessage('${message.id}')" class="p-1 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded transition duration-200" title="Edit message">
                    <i class="fas fa-edit text-xs"></i>
                </button>
            `;
        }

        messageHTML += `
                <button onclick="unsendMessage('${message.id}')" class="p-1 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition duration-200" title="Unsend message">
                    <i class="fas fa-trash text-xs"></i>
                </button>
                <div class="relative">
                    <button onclick="toggleReactions('${message.id}')" class="p-1 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded transition duration-200" title="Add reaction">
                        <i class="fas fa-smile text-xs"></i>
                    </button>
                    <div id="reactions-${message.id}" class="reaction-picker absolute bottom-full left-0 bg-white border border-gray-300 rounded-lg shadow-lg p-2 hidden grid grid-cols-3 gap-1 z-50">
                        ${createReactionButtons(message.id)}
                    </div>
                </div>
            </div>
        `;
    } else if (!isUnsent) {
        messageHTML += `
            <div class="message-actions absolute -top-8 right-0 bg-white border border-gray-300 rounded-lg shadow-lg p-1 hidden group-hover:flex">
                <div class="relative">
                    <button onclick="toggleReactions('${message.id}')" class="p-1 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded transition duration-200" title="Add reaction">
                        <i class="fas fa-smile text-xs"></i>
                    </button>
                    <div id="reactions-${message.id}" class="reaction-picker absolute bottom-full left-0 bg-white border border-gray-300 rounded-lg shadow-lg p-2 hidden grid grid-cols-3 gap-1 z-50">
                        ${createReactionButtons(message.id)}
                    </div>
                </div>
            </div>
        `;
    }

    messageHTML += `</div>`;
    return messageHTML;
}

function createReactionButtons(messageId) {
    const emojis = ['ğŸ‘', 'â¤ï¸', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢', 'ğŸ˜¡'];
    return emojis.map(emoji =>
        `<button onclick="addReaction('${messageId}', '${emoji}')" class="p-1 hover:bg-gray-100 rounded text-lg transition duration-200 mobile-reaction-btn">${emoji}</button>`
    ).join('');
}

function showTypingIndicator(typingUsers) {
    const typingText = document.getElementById('typing-text');
    if (typingUsers.length === 1) {
        typingText.textContent = `${typingUsers[0]} is typing...`;
    } else if (typingUsers.length === 2) {
        typingText.textContent = `${typingUsers[0]} and ${typingUsers[1]} are typing...`;
    } else {
        typingText.textContent = 'Several people are typing...';
    }
    document.getElementById('typing-indicator').classList.remove('hidden');
    scrollToBottom();
}

function hideTypingIndicator() {
    document.getElementById('typing-indicator').classList.add('hidden');
}

function startTyping() {
    // Clear existing timer
    clearTimeout(typingTimer);

    fetch(`/chat/${conversationId}/typing/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            is_typing: true
        })
    }).catch(error => console.error('Error sending typing indicator:', error));

    // Set new timer to stop typing
    typingTimer = setTimeout(stopTyping, TYPING_TIMEOUT);
}

function stopTyping() {
    fetch(`/chat/${conversationId}/typing/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            is_typing: false
        })
    }).catch(error => console.error('Error stopping typing indicator:', error));
}

function addMessageToUI(messageData, isOwn) {
    const messagesList = document.getElementById('messages-list');
    if (!messagesList) return;

    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.className = `message-group flex ${isOwn ? 'justify-end' : 'justify-start'} message-fade-in`;
    messageDiv.setAttribute('data-message-id', messageData.message_id);

    messageDiv.innerHTML = createMessageHTML(messageData, isOwn);
    messagesList.appendChild(messageDiv);

    // Remove empty state
    const emptyState = document.getElementById('empty-state');
    if (emptyState) {
        emptyState.remove();
    }

    // Scroll to bottom
    scrollToBottom();
}

// Set up periodic updates
setInterval(checkForUpdates, 2000);

// Update online status when page loads and when user becomes active
setTimeout(() => {
    updateOnlineStatus(true);
}, 1000);

window.addEventListener('focus', function() {
    updateOnlineStatus(true);
});

window.addEventListener('blur', function() {
    updateOnlineStatus(false);
});

// Block user function
function blockUser() {
    const userId = '{{ other_user.id }}';
    if (!userId) return;

    if (confirm('Are you sure you want to block this user?')) {
        fetch(`/chat/block/${userId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.href = '{% url "chat_home" %}';
            } else {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error('Error blocking user:', error);
            alert('Error blocking user');
        });
    }
}

// Mobile detection
function isMobile() {
    return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
    loadEmojiCategories();
    loadEmojisByCategory('smileys_people');
});
</script>

<style>
/* Mobile-specific styles */
@media (max-width: 768px) {
    .mobile-chat-container {
        height: 100vh !important;
        max-height: -webkit-fill-available !important;
    }

    .mobile-chat-header {
        padding: 12px 16px;
    }

    .mobile-back-btn {
        font-size: 18px;
    }

    .mobile-messages-area {
        padding: 12px;
        padding-bottom: 80px;
    }

    .message-bubble {
        max-width: 85% !important;
    }

    .mobile-input-container {
        padding: 12px;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #e5e7eb;
    }

    .mobile-input-row {
        flex-wrap: nowrap;
    }

    .mobile-message-input {
        min-height: 44px;
        font-size: 16px; /* Prevent iOS zoom */
    }

    .mobile-send-btn {
        min-width: 44px;
        min-height: 44px;
    }

    .mobile-emoji-btn, .mobile-attach-btn {
        min-width: 44px;
        min-height: 44px;
    }

    #emoji-picker {
        height: 300px !important;
        bottom: 70px !important;
        left: 10px !important;
        right: 10px !important;
        width: auto !important;
        max-height: 50vh;
    }

    .emoji-grid {
        grid-template-columns: repeat(6, 1fr) !important;
        gap: 4px !important;
    }

    .mobile-emoji-option {
        padding: 8px !important;
        font-size: 24px !important;
    }

    .mobile-category-btn {
        padding: 8px 12px !important;
    }

    .mobile-media {
        max-width: 100% !important;
        border-radius: 12px !important;
    }

    .mobile-audio {
        width: 100% !important;
    }

    .mobile-edit-modal {
        width: 90% !important;
        max-width: 400px !important;
        margin: 20px !important;
    }

    .mobile-edit-textarea {
        font-size: 16px !important;
        min-height: 100px !important;
    }

    .mobile-cancel-btn, .mobile-save-btn {
        min-height: 44px !important;
        padding: 12px 24px !important;
    }

    .mobile-modal-close {
        top: 10px !important;
        right: 10px !important;
        font-size: 24px !important;
    }

    .mobile-full-image, .mobile-full-video {
        max-height: 80vh !important;
        object-fit: contain !important;
    }

    .mobile-reaction-btn {
        min-width: 44px;
        min-height: 44px;
    }

    .mobile-reaction-badge {
        padding: 2px 6px !important;
        font-size: 11px !important;
    }

    .mobile-reaction-option {
        font-size: 28px !important;
        padding: 12px !important;
    }

    .mobile-file-input {
        position: fixed;
        top: -1000px;
    }
}

/* Enhanced emoji styles for mobile */
.emoji-message {
    font-size: 2.5rem !important;
    line-height: 1.2;
}

/* Message animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message-fade-in {
    animation: fadeIn 0.3s ease-out;
}

/* Better touch targets */
button,
a {
    min-height: 44px;
    min-width: 44px;
}

/* Smooth transitions */
* {
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
}

/* Prevent text selection on mobile */
@media (max-width: 768px) {
    * {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    input, textarea {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
    }
}

/* Mobile toast */
.mobile-toast {
    animation: slideUp 0.3s ease;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

@keyframes slideUp {
    from {
        transform: translate(-50%, 100%);
        opacity: 0;
    }
    to {
        transform: translate(-50%, 0);
        opacity: 1;
    }
}

/* Typing indicator animation */
.typing-dot {
    animation: typingBounce 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) {
    animation-delay: -0.32s;
}

.typing-dot:nth-child(2) {
    animation-delay: -0.16s;
}

@keyframes typingBounce {
    0%, 80%, 100% {
        transform: scale(0);
    }
    40% {
        transform: scale(1);
    }
}
</style>
{% endblock %}