{% extends 'base.html' %}

{% block title %}Blocked Users - Connect.io{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <h1 class="text-2xl font-bold text-gray-800">Blocked Users</h1>
            <p class="text-gray-600 mt-1">{{ blocked_users|length }} users blocked</p>

            <!-- Navigation Tabs -->
            <div class="flex space-x-4 mt-4">
                <a href="{% url 'discover_users' %}"
                   class="px-4 py-2 text-sm font-medium rounded-lg transition duration-200 text-gray-600 hover:text-gray-900">
                    Discover People
                </a>
                <a href="{% url 'blocked_users' %}"
                   class="px-4 py-2 text-sm font-medium rounded-lg transition duration-200 bg-blue-100 text-blue-700">
                    Blocked Users
                </a>
            </div>
        </div>

        <div class="p-6">
            {% if blocked_users %}
            <div class="space-y-4">
                {% for blocked in blocked_users %}
                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:shadow-md transition duration-200">
                    <div class="flex items-center space-x-4">
                        {% if blocked.blocked_user.profile_picture %}
                        <img class="h-12 w-12 rounded-full object-cover border-2 border-gray-300"
                             src="{{ blocked.blocked_user.profile_picture.url }}"
                             alt="{{ blocked.blocked_user.username }}">
                        {% else %}
                        <div class="h-12 w-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center border-2 border-gray-300">
                            <span class="text-white font-semibold text-sm">{{ blocked.blocked_user.username|first|upper }}</span>
                        </div>
                        {% endif %}
                        <div>
                            <h3 class="font-semibold text-gray-800">{{ blocked.blocked_user.username }}</h3>
                            <p class="text-sm text-gray-600">{{ blocked.blocked_user.email }}</p>
                            {% if blocked.reason %}
                            <p class="text-xs text-gray-500 mt-1">Reason: {{ blocked.reason }}</p>
                            {% endif %}
                            <p class="text-xs text-gray-500">Blocked on: {{ blocked.created_at|date:"M d, Y" }}</p>
                        </div>
                    </div>

                    <form method="post" action="{% url 'unblock_user' blocked.blocked_user.id %}" class="unblock-form">
                        {% csrf_token %}
                        <button type="submit"
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 flex items-center space-x-2"
                                onclick="return confirm('Are you sure you want to unblock {{ blocked.blocked_user.username }}?')">
                            <i class="fas fa-unlock"></i>
                            <span>Unblock</span>
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12">
                <i class="fas fa-user-slash text-gray-300 text-5xl mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">No blocked users</h3>
                <p class="text-gray-500">
                    You haven't blocked any users yet.
                </p>
                <a href="{% url 'discover_users' %}" class="inline-block mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                    Discover People
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Handle unblock form submissions with AJAX
    document.addEventListener('DOMContentLoaded', function() {
        const unblockForms = document.querySelectorAll('.unblock-form');

        unblockForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(this);
                const url = this.action;
                const button = this.querySelector('button');
                const originalText = button.innerHTML;

                // Show loading state
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Unblocking...';
                button.disabled = true;

                fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the blocked user from the DOM
                        const userCard = this.closest('.flex.items-center');
                        userCard.style.opacity = '0';
                        userCard.style.transition = 'opacity 0.3s ease';

                        setTimeout(() => {
                            userCard.remove();

                            // Show success message
                            showToast(data.message || 'User unblocked successfully', 'success');

                            // Update blocked users count
                            const blockedCount = document.querySelector('.text-gray-600.mt-1');
                            if (blockedCount) {
                                const currentCount = parseInt(blockedCount.textContent.match(/\d+/)[0]);
                                blockedCount.textContent = blockedCount.textContent.replace(currentCount, currentCount - 1);
                            }

                            // If no more blocked users, show empty state
                            if (document.querySelectorAll('.unblock-form').length === 0) {
                                location.reload(); // Reload to show empty state
                            }
                        }, 300);
                    } else {
                        showToast(data.error || 'Error unblocking user', 'error');
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error unblocking user', 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                });
            });
        });
    });

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Toast notification function
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white ${
            type === 'success' ? 'bg-green-500' :
            type === 'error' ? 'bg-red-500' : 'bg-blue-500'
        } z-50 transform transition-transform duration-300 translate-x-full`;
        toast.textContent = message;

        document.body.appendChild(toast);

        // Animate in
        setTimeout(() => {
            toast.classList.remove('translate-x-full');
        }, 100);

        // Remove after 3 seconds
        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }
</script>
{% endblock %}